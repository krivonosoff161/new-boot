# v2.0 (–æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –±–æ—Ç–∞–º–∏ v2.0)
"""
–ê–Ω–∞–ª–∏–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ç–æ—Ä–≥–æ–≤—ã—Ö –±–æ—Ç–æ–≤.
v2.0: –û–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –±–æ—Ç–∞–º–∏ v2.0.
"""
import ccxt.async_support as ccxt
import numpy as np
import talib
import asyncio
import time
import logging
import sys
import os
import json
import math
from datetime import datetime, timedelta
from dotenv import load_dotenv
# –ò–º–ø–æ—Ä—Ç –º–æ–¥—É–ª–µ–π –ø—Ä–æ–µ–∫—Ç–∞
from config_manager import ConfigManager
# –ò–º–ø–æ—Ä—Ç –±–∞–∑–æ–≤–æ–≥–æ –∫–ª–∞—Å—Å–∞ –∏ TradeEvent –¥–ª—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ –ª–æ–≥–æ–≤
from base_trading_bot import BaseTradingBot, TradeEvent

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()
os.makedirs('logs', exist_ok=True)
os.makedirs('reports', exist_ok=True)

# === v2.0: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è ===
# - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ConfigManager –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
# - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ª–æ–≥–≥–µ—Ä–∞ –∏–∑ BaseTradingBot –¥–ª—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏
# - –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ø—É—Ç–µ–π –∫ —Ñ–∞–π–ª–∞–º
# === /v2.0 ===

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–≥–µ—Ä–∞, –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥—Ä—É–≥–∏–º –±–æ—Ç–∞–º
logger_instance = BaseTradingBot('analyzer') # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Ç–æ–ª—å–∫–æ –¥–ª—è –ª–æ–≥–≥–µ—Ä–∞
logger = logger_instance.logger

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
config_manager = ConfigManager()
CONFIG = config_manager.get_config()
SYMBOLS = CONFIG['symbols']

def analyze_log_file(bot_type):
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ª–æ–≥-—Ñ–∞–π–ª –±–æ—Ç–∞.
    v2.0: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—É—Ç–µ–π –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ª–æ–≥–æ–≤ –∏–∑ v2.0.
    """
    log_file_path = f'logs/{bot_type}_bot.log'
    if not os.path.exists(log_file_path):
        logger.warning(f"–õ–æ–≥-—Ñ–∞–π–ª {log_file_path} –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return {
            "total_lines": 0,
            "errors": 0,
            "warnings": 0,
            "trades": 0,
            "start_time": None,
            "end_time": None
        }

    stats = {
        "total_lines": 0,
        "errors": 0,
        "warnings": 0,
        "trades": 0,
        "start_time": None,
        "end_time": None
    }

    try:
        with open(log_file_path, 'r', encoding='utf-8') as f:
            first_line = True
            for line in f:
                stats["total_lines"] += 1
                if "ERROR" in line:
                    stats["errors"] += 1
                if "WARNING" in line:
                    stats["warnings"] += 1
                if "–û–¢–ö–†–´–¢–ò–ï" in line or "–ó–ê–ö–†–´–¢–ò–ï" in line:
                    stats["trades"] += 1
                
                # –ü–æ–ø—ã—Ç–∫–∞ –∏–∑–≤–ª–µ—á—å –≤—Ä–µ–º—è –∏–∑ –ø–µ—Ä–≤–æ–π –∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–æ–∫
                try:
                    # –§–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏ –≤ –ª–æ–≥–∞—Ö: 2024-05-21 10:00:00,123
                    timestamp_str = line.split(' - ')[0]
                    log_time = datetime.strptime(timestamp_str, '%Y-%m-%d %H:%M:%S')
                    if first_line:
                        stats["start_time"] = log_time
                        first_line = False
                    stats["end_time"] = log_time
                except ValueError:
                    # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –≤—Ä–µ–º—è, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
                    pass
                    
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –ª–æ–≥-—Ñ–∞–π–ª–∞ {log_file_path}: {e}")
        return stats
        
    return stats

def generate_report(bot_type, log_stats):
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç.
    v2.0: –£–ª—É—á—à–µ–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç—á–µ—Ç–∞.
    """
    report_lines = []
    report_lines.append("=" * 50)
    report_lines.append(f"–û—Ç—á–µ—Ç –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è {bot_type.upper()} –±–æ—Ç–∞")
    report_lines.append(f"–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    report_lines.append("=" * 50)
    report_lines.append("")

    if log_stats:
        duration = "N/A"
        if log_stats['start_time'] and log_stats['end_time']:
            duration_td = log_stats['end_time'] - log_stats['start_time']
            duration_hours = duration_td.total_seconds() / 3600
            duration = f"{duration_hours:.2f} —á–∞—Å–æ–≤"
            
        report_lines.append("--- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ª–æ–≥–æ–≤ ---")
        report_lines.append(f"  –í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫: {log_stats['total_lines']}")
        report_lines.append(f"  –û—à–∏–±–æ–∫: {log_stats['errors']}")
        report_lines.append(f"  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π: {log_stats['warnings']}")
        report_lines.append(f"  –°–¥–µ–ª–æ–∫: {log_stats['trades']}")
        report_lines.append(f"  –ù–∞—á–∞–ª–æ –ª–æ–≥–æ–≤: {log_stats['start_time'].strftime('%Y-%m-%d %H:%M:%S') if log_stats['start_time'] else 'N/A'}")
        report_lines.append(f"  –ö–æ–Ω–µ—Ü –ª–æ–≥–æ–≤: {log_stats['end_time'].strftime('%Y-%m-%d %H:%M:%S') if log_stats['end_time'] else 'N/A'}")
        report_lines.append(f"  –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {duration}")
    else:
        report_lines.append("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ª–æ–≥–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.")

    report_lines.append("")
    report_lines.append("=" * 50)
    report_lines.append("–ö–æ–Ω–µ—Ü –æ—Ç—á–µ—Ç–∞")
    report_lines.append("=" * 50)
    
    return "\n".join(report_lines)

async def analyze_exchange_data():
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å –±–∏—Ä–∂–∏ (–±–∞–ª–∞–Ω—Å—ã, –ø–æ–∑–∏—Ü–∏–∏).
    v2.0: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞, —É–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫.
    """
    report_lines = []
    report_lines.append("--- –î–∞–Ω–Ω—ã–µ —Å –±–∏—Ä–∂–∏ ---")
    
    try:
        API_KEY = os.getenv('API_KEY')
        API_SECRET = os.getenv('API_SECRET')
        PASSPHRASE = os.getenv('PASSPHRASE')
        
        if not all([API_KEY, API_SECRET, PASSPHRASE]):
             report_lines.append("‚ùå API –∫–ª—é—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ .env")
             return "\n".join(report_lines)

        exchange = ccxt.okx({
            'apiKey': API_KEY,
            'secret': API_SECRET,
            'password': PASSPHRASE,
            'sandbox': True, # –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ-—Ä–µ–∂–∏–º, –∫–∞–∫ –≤ –±–æ—Ç–∞—Ö
            'enableRateLimit': True,
            'options': {'defaultType': 'spot'}
        })
        
        await exchange.load_markets()
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
        balance = await exchange.fetch_balance({'type': 'spot'})
        report_lines.append("–ë–∞–ª–∞–Ω—Å—ã:")
        total_equity = 0.0
        for symbol in SYMBOLS:
            try:
                base_currency = symbol.split('/')[0]
                quote_currency = symbol.split('/')[1]
                base_balance = balance['total'].get(base_currency, 0)
                quote_balance = balance['total'].get(quote_currency, 0)
                
                if base_balance > 1e-8 or quote_balance > 1e-8:
                    # –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—É –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —ç–∫–≤–∏—Ç–∏
                    ticker = await exchange.fetch_ticker(symbol)
                    price = ticker['last']
                    equity = base_balance * price + quote_balance
                    total_equity += equity
                    report_lines.append(f"  {symbol}: {base_balance:.6f} {base_currency} + {quote_balance:.2f} {quote_currency} ‚âà ${equity:.2f}")
            except Exception as e:
                report_lines.append(f"  {symbol}: –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö - {e}")
        
        report_lines.append(f"–û–±—â–µ–µ —ç–∫–≤–∏—Ç–∏ (–ø—Ä–∏–º–µ—Ä–Ω–æ–µ): ${total_equity:.2f} USDT")
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤
        report_lines.append("\n–û—Ç–∫—Ä—ã—Ç—ã–µ –æ—Ä–¥–µ—Ä–∞:")
        total_orders = 0
        for symbol in SYMBOLS:
            try:
                orders = await exchange.fetch_open_orders(symbol)
                if orders:
                    report_lines.append(f"  {symbol}:")
                    for order in orders:
                        total_orders += 1
                        side = order['side']
                        price = order['price']
                        amount = order['amount']
                        report_lines.append(f"    - {side.upper()} {amount:.6f} @ {price:.2f}")
            except Exception as e:
                report_lines.append(f"  {symbol}: –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ä–¥–µ—Ä–æ–≤ - {e}")
        
        if total_orders == 0:
            report_lines.append("  –ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤.")
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å –±–∏—Ä–∂–∏: {e}")
        report_lines.append(f"‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å –±–∏—Ä–∂–∏: {e}")
        
    return "\n".join(report_lines)

async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞"""
    if len(sys.argv) < 2:
        print("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: python multi_analyze_stats.py <bot_type>")
        print("  bot_type: 'grid', 'scalp' –∏–ª–∏ 'all'")
        sys.exit(1)

    bot_type = sys.argv[1]
    
    if not os.path.exists('.env'):
        print("‚ùå –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        print("–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env —Å –≤–∞—à–∏–º–∏ API –∫–ª—é—á–∞–º–∏")
        sys.exit(1)

    logger.info(f"–ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è '{bot_type}'...")
    
    full_report = []
    full_report.append(f"–ú–ê–°–®–¢–ê–ë–ù–´–ô –ê–ù–ê–õ–ò–ó –¢–û–†–ì–û–í–û–ì–û –ë–û–¢–ê - {bot_type.upper()}")
    full_report.append(f"–í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    full_report.append("-" * 60)
    full_report.append("")

    try:
        if bot_type in ['grid', 'scalp']:
            log_stats = analyze_log_file(bot_type)
            report = generate_report(bot_type, log_stats)
            full_report.append(report)
            full_report.append("")
            
        elif bot_type == 'all':
            # –ê–Ω–∞–ª–∏–∑ Grid
            log_stats_grid = analyze_log_file('grid')
            report_grid = generate_report('grid', log_stats_grid)
            full_report.append(report_grid)
            full_report.append("")
            
            # –ê–Ω–∞–ª–∏–∑ Scalp
            log_stats_scalp = analyze_log_file('scalp')
            report_scalp = generate_report('scalp', log_stats_scalp)
            full_report.append(report_scalp)
            full_report.append("")
        else:
            logger.error(f"–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø –±–æ—Ç–∞: {bot_type}")
            full_report.append(f"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø –±–æ—Ç–∞: {bot_type}")
            full_report.append("–î–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: 'grid', 'scalp', 'all'")
            full_report.append("")
            
        # –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö —Å –±–∏—Ä–∂–∏
        exchange_report = await analyze_exchange_data()
        full_report.append(exchange_report)
        full_report.append("")
        
    except Exception as e:
        logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞: {e}")
        full_report.append(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞: {e}")
        
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –≤ —Ñ–∞–π–ª
    timestamp_str = datetime.now().strftime('%Y%m%d_%H%M%S')
    report_filename = f"reports/analysis_report_{bot_type}_{timestamp_str}.txt"
    
    try:
        with open(report_filename, 'w', encoding='utf-8') as f:
            f.write("\n".join(full_report))
        logger.info(f"‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω. –û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ '{report_filename}'")
        print(f"‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω. –û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ '{report_filename}'")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞ –≤ —Ñ–∞–π–ª: {e}")
        print(f"‚ö†Ô∏è –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω, –Ω–æ –æ—Ç—á–µ—Ç –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ–∞–π–ª: {e}")
        print("\n--- –ù–ê–ß–ê–õ–û –û–¢–ß–ï–¢–ê ---")
        print("\n".join(full_report))
        print("--- –ö–û–ù–ï–¶ –û–¢–ß–ï–¢–ê ---")

if __name__ == "__main__":
    asyncio.run(main())



# v2.0 (–æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –±–æ—Ç–∞–º–∏)
"""
–ú–æ–¥—É–ª—å IPC (Inter-Process Communication) –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –±–æ—Ç–∞–º–∏.
v2.0: –û–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –±–æ—Ç–∞–º–∏, –¥–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.
"""
import asyncio
import logging
from aiohttp import web, ClientSession
import json
import time

logger = logging.getLogger(__name__)

# === –ö–õ–ò–ï–ù–¢ ===

class BotIPCClient:
    """
    –ö–ª–∏–µ–Ω—Ç IPC –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –±–æ—Ç–∞–º–∏.
    v2.0: –û–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –±–æ—Ç–∞–º–∏.
    """
    def __init__(self, base_url):
        self.base_url = base_url.rstrip('/')
        self.session = None

    async def start(self):
        """–ó–∞–ø—É—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞ (—Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏)"""
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º timeout –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        timeout = aiohttp.ClientTimeout(total=10) 
        self.session = ClientSession(timeout=timeout)
        logger.debug(f"IPC –∫–ª–∏–µ–Ω—Ç –∑–∞–ø—É—â–µ–Ω –¥–ª—è {self.base_url}")

    async def close(self):
        """–ó–∞–∫—Ä—ã—Ç–∏–µ –∫–ª–∏–µ–Ω—Ç–∞"""
        if self.session:
            await self.session.close()
            logger.debug(f"IPC –∫–ª–∏–µ–Ω—Ç –∑–∞–∫—Ä—ã—Ç –¥–ª—è {self.base_url}")

    async def get_status(self):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –±–æ—Ç–∞"""
        if not self.session:
            return {"error": "–ö–ª–∏–µ–Ω—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω"}
        try:
            async with self.session.get(f"{self.base_url}/status") as resp:
                if resp.status == 200:
                    data = await resp.json()
                    return data
                else:
                    return {"error": f"HTTP {resp.status}"}
        except asyncio.TimeoutError:
            return {"error": "–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞"}
        except Exception as e:
            logger.error(f"IPC –æ—à–∏–±–∫–∞ get_status: {e}")
            return {"error": str(e)}

    # v2.0: –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
    async def send_stop_command(self):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞"""
        if not self.session:
            return {"error": "–ö–ª–∏–µ–Ω—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω"}
        try:
            async with self.session.post(f"{self.base_url}/stop") as resp:
                if resp.status == 200:
                    data = await resp.json()
                    logger.info(f"–ö–æ–º–∞–Ω–¥–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ {self.base_url}")
                    return data
                else:
                    error_msg = f"HTTP {resp.status}"
                    logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞ {self.base_url}: {error_msg}")
                    return {"error": error_msg}
        except asyncio.TimeoutError:
            error_msg = "–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏"
            logger.error(f"–¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–º–∞–Ω–¥—ã –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞ {self.base_url}")
            return {"error": error_msg}
        except Exception as e:
            logger.error(f"IPC –æ—à–∏–±–∫–∞ send_stop_command: {e}")
            return {"error": str(e)}


# === –°–ï–†–í–ï–† –î–õ–Ø GRID –ë–û–¢–ê ===

class GridBotIPCServer:
    """
    –°–µ—Ä–≤–µ—Ä IPC –¥–ª—è Grid-–±–æ—Ç–∞.
    v2.0: –û–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å Grid-–±–æ—Ç–æ–º, –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.
    """
    def __init__(self, bot_instance, port=8081):
        self.bot = bot_instance
        self.port = port
        self.runner = None
        self.site = None

    async def status_handler(self, request):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–∞ —Å—Ç–∞—Ç—É—Å–∞"""
        try:
            # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª
            await self.bot.update_capital()
            
            # –°–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∑–∏—Ü–∏—è—Ö/–æ—Ä–¥–µ—Ä–∞—Ö
            positions_info = []
            for symbol, orders_dict in self.bot.asset_grids.items():
                for order_id, order_info in orders_dict.items():
                    positions_info.append({
                        'symbol': symbol,
                        'order_id': order_id,
                        'type': order_info['type'],
                        'price': order_info['price'],
                        'amount': order_info['amount'],
                        'level': order_info['level']
                    })
            
            data = {
                'status': 'running',
                'timestamp': time.time(),
                'equity': self.bot.total_capital,
                'working_capital': self.bot.working_capital,
                'reserve_capital': self.bot.reserve_capital,
                'positions': positions_info,
                'allocated_capital': self.bot.allocated_capital
            }
            return web.json_response(data)
        except Exception as e:
            logger.error(f"IPC –æ—à–∏–±–∫–∞ status_handler: {e}")
            return web.json_response({'error': str(e)}, status=500)

    # v2.0: –î–æ–±–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
    async def stop_handler(self, request):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã –æ—Å—Ç–∞–Ω–æ–≤–∫–∏"""
        try:
            logger.info("–ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —á–µ—Ä–µ–∑ IPC –¥–ª—è Grid-–±–æ—Ç–∞")
            # –í—ã–∑—ã–≤–∞–µ–º –º–µ—Ç–æ–¥ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–π –±–æ—Ç–∞
            await self.bot.close_all_positions()
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
            self.bot.running = False
            return web.json_response({'message': 'Grid-–±–æ—Ç –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è, –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è'})
        except Exception as e:
            logger.error(f"IPC –æ—à–∏–±–∫–∞ stop_handler: {e}")
            return web.json_response({'error': str(e)}, status=500)

    async def start(self):
        """–ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞"""
        try:
            app = web.Application()
            app.add_routes([
                web.get('/status', self.status_handler),
                # v2.0: –î–æ–±–∞–≤–ª–µ–Ω –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                web.post('/stop', self.stop_handler),
            ])
            self.runner = web.AppRunner(app)
            await self.runner.setup()
            self.site = web.TCPSite(self.runner, 'localhost', self.port)
            await self.site.start()
            logger.info(f"Grid IPC —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://localhost:{self.port}")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ Grid IPC —Å–µ—Ä–≤–µ—Ä–∞: {e}")

    async def stop(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞"""
        if self.site:
            await self.site.stop()
        if self.runner:
            await self.runner.cleanup()
        logger.info("Grid IPC —Å–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")


# === –°–ï–†–í–ï–† –î–õ–Ø SCALP –ë–û–¢–ê ===

class ScalpBotIPCServer:
    """
    –°–µ—Ä–≤–µ—Ä IPC –¥–ª—è Scalp-–±–æ—Ç–∞.
    v2.0: –û–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å Scalp-–±–æ—Ç–æ–º, –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.
    """
    def __init__(self, bot_instance, port=8082):
        self.bot = bot_instance
        self.port = port
        self.runner = None
        self.site = None

    async def status_handler(self, request):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–∞ —Å—Ç–∞—Ç—É—Å–∞"""
        try:
            # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª
            await self.bot.update_capital()
            
            # –°–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∑–∏—Ü–∏—è—Ö
            positions_info = []
            for symbol, pos_info in self.bot.positions.items():
                positions_info.append({
                    'symbol': symbol,
                    'side': pos_info['side'],
                    'amount': pos_info['amount'],
                    'entry_price': pos_info['entry'],
                    'open_time': pos_info['timestamp']
                })
            
            data = {
                'status': 'running',
                'timestamp': time.time(),
                'equity': self.bot.total_capital,
                'working_capital': self.bot.working_capital,
                'reserve_capital': self.bot.reserve_capital,
                'positions': positions_info,
                'allocated_capital': self.bot.allocated_capital
            }
            return web.json_response(data)
        except Exception as e:
            logger.error(f"IPC –æ—à–∏–±–∫–∞ status_handler: {e}")
            return web.json_response({'error': str(e)}, status=500)

    # v2.0: –î–æ–±–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
    async def stop_handler(self, request):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã –æ—Å—Ç–∞–Ω–æ–≤–∫–∏"""
        try:
            logger.info("–ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —á–µ—Ä–µ–∑ IPC –¥–ª—è Scalp-–±–æ—Ç–∞")
            # –í—ã–∑—ã–≤–∞–µ–º –º–µ—Ç–æ–¥ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–π –±–æ—Ç–∞
            await self.bot.close_all_positions()
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
            self.bot.running = False
            return web.json_response({'message': 'Scalp-–±–æ—Ç –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è, –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è'})
        except Exception as e:
            logger.error(f"IPC –æ—à–∏–±–∫–∞ stop_handler: {e}")
            return web.json_response({'error': str(e)}, status=500)

    async def start(self):
        """–ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞"""
        try:
            app = web.Application()
            app.add_routes([
                web.get('/status', self.status_handler),
                # v2.0: –î–æ–±–∞–≤–ª–µ–Ω –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                web.post('/stop', self.stop_handler),
            ])
            self.runner = web.AppRunner(app)
            await self.runner.setup()
            self.site = web.TCPSite(self.runner, 'localhost', self.port)
            await self.site.start()
            logger.info(f"Scalp IPC —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://localhost:{self.port}")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ Scalp IPC —Å–µ—Ä–≤–µ—Ä–∞: {e}")

    async def stop(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞"""
        if self.site:
            await self.site.stop()
        if self.runner:
            await self.runner.cleanup()
        logger.info("Scalp IPC —Å–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")



# v2.0 (–æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å Telegram)
"""
–ú–æ–¥—É–ª—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.
v2.0: –û–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å Telegram.
"""
import json
import logging
import os
from telegram import Bot

logger = logging.getLogger(__name__)
USERS_FILE = 'users.json'

class SecurityManager:
    """
    –ú–æ–¥—É–ª—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.
    v2.0: –û–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å Telegram.
    """
    def __init__(self, users_file=USERS_FILE, telegram_token=None):
        self.users_file = users_file
        self.telegram_token = telegram_token
        self.users = self.load_users()

    def load_users(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
        if os.path.exists(self.users_file):
            try:
                with open(self.users_file, 'r') as f:
                    data = json.load(f)
                    # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —ç—Ç–æ —Å–ø–∏—Å–æ–∫
                    if isinstance(data, list):
                        logger.info(f"‚úÖ –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ {self.users_file}")
                        return data
                    else:
                        logger.warning(f"‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ {self.users_file}. –°–æ–∑–¥–∞—é –Ω–æ–≤—ã–π —Å–ø–∏—Å–æ–∫.")
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ {self.users_file}: {e}")
        # –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –æ—à–∏–±–∫–∞, —Å–æ–∑–¥–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —Å–ø–∏—Å–æ–∫
        # –ü–µ—Ä–≤—ã–µ –¥–≤–∞ ID - –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        default_users = [462885677, 5954433829] # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ ID –∞–¥–º–∏–Ω–æ–≤
        self.save_users(default_users)
        logger.info(f"üÜï –°–æ–∑–¥–∞–Ω –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ {self.users_file}")
        return default_users

    def save_users(self, users_list=None):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
        if users_list is not None:
            self.users = users_list
        try:
            with open(self.users_file, 'w') as f:
                json.dump(self.users, f, indent=2)
            logger.info(f"‚úÖ –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ {self.users_file}")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è {self.users_file}: {e}")

    def is_authorized(self, user_id):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"""
        return int(user_id) in self.users

    def is_admin(self, user_id):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º"""
        # –ü–µ—Ä–≤—ã–µ –¥–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–ø–∏—Å–∫–µ - –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã
        return int(user_id) in self.users[:2] if len(self.users) >= 2 else int(user_id) == self.users[0] if self.users else False

    def add_user(self, user_id):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        user_id = int(user_id)
        if user_id not in self.users:
            self.users.append(user_id)
            self.save_users()
            logger.info(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –¥–æ–±–∞–≤–ª–µ–Ω")
            return True
        else:
            logger.info(f"‚ÑπÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
            return False

    def remove_user(self, user_id):
        """–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        user_id = int(user_id)
        if user_id in self.users:
            # –ù–µ –ø–æ–∑–≤–æ–ª—è–µ–º —É–¥–∞–ª–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
            if self.is_admin(user_id):
                logger.warning(f"‚ö†Ô∏è –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ {user_id}")
                return False
            self.users.remove(user_id)
            self.save_users()
            logger.info(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —É–¥–∞–ª–µ–Ω")
            return True
        else:
            logger.info(f"‚ÑπÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return False

    def get_users(self):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
        return self.users.copy()

    async def notify_admins(self, tg_bot: Bot, user_id, username, first_name, last_name):
        """–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –æ –Ω–æ–≤–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"""
        try:
            message = (f"üîí –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞\n"
                       f"ID: <code>{user_id}</code>\n"
                       f"Username: @{username}\n"
                       f"–ò–º—è: {first_name}\n"
                       f"–§–∞–º–∏–ª–∏—è: {last_name}\n\n"
                       f"–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É:\n"
                       f"<code>/add_user {user_id}</code>")
            
            for admin_id in self.users[:2]: # –£–≤–µ–¥–æ–º–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã—Ö –¥–≤—É—Ö –∞–¥–º–∏–Ω–æ–≤
                try:
                    await tg_bot.send_message(chat_id=admin_id, text=message, parse_mode='HTML')
                except Exception as e:
                    logger.error(f"‚ùå –û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ {admin_id}: {e}")
            logger.info(f"‚ÑπÔ∏è –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤: {e}")


# v2.0 (+–ø—Ä–∞–≤–∫–∏ –∏–∑ –∞–Ω–∞–ª–∏–∑–∞: –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏)
"""
–ú–µ–Ω–µ–¥–∂–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.
v2.0: –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ —á–µ–∫-–ª–∏—Å—Ç–∞.
"""
import json
import os
import logging

logger = logging.getLogger(__name__)

CONFIG_FILE = 'bot_config.json'

class ConfigManager:
    """
    –ú–µ–Ω–µ–¥–∂–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.
    v2.0: –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ —á–µ–∫-–ª–∏—Å—Ç–∞.
    """
    def __init__(self):
        self.config = self.load_config()

    def load_config(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"""
        # –î–µ—Ñ–æ–ª—Ç–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å –Ω–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
        default_config = {
            "symbols": ["BTC/USDT", "ETH/USDT", "BNB/USDT", "SOL/USDT", "XRP/USDT", "ADA/USDT", "DOT/USDT"],
            "chat_ids": [462885677, 5954433829],
            "redistribution_interval": 1800, # 30 –º–∏–Ω—É—Ç
            # v2.0: –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä min_alloc_usd
            "min_alloc_usd": 100,
            # v2.0: –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä balance_cache_sec
            "balance_cache_sec": 60,
            "capital_split": { # –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –∫–∞–ø–∏—Ç–∞–ª–∞
                "grid": 0.6,
                "scalp": 0.4
            },
            "grid": {
                "min_order_usd": 20,
                "max_position_size": 200,
                "exposure_limit": 0.5,
                "base_spacing": 0.008,
                "max_levels": 6,
                "sleep_interval": 15,
                # v2.0: –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä cci_block
                "cci_block": -150,
                # v2.0: –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä grid_mode
                "grid_mode": "futures",
                "order_timeout_seconds": 600 # –¢–∞–π–º–∞—É—Ç –æ—Ä–¥–µ—Ä–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            },
            "scalp": {
                "min_order_usd": 15,
                "max_positions": 8,
                "position_size_percent": 0.05,
                "sleep_interval": 5, # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Å 2 –Ω–∞ 5
                "signal_threshold": 50,
                "max_hold_seconds": 180,
                "tp_pct": 0.15,
                "sl_pct": 0.25,
                "fee_rate": 0.0004, # –ü—Ä–∏–º–µ—Ä –∫–æ–º–∏—Å—Å–∏–∏
                "indicators": {
                    "rsi": {
                        "timeperiod": 3
                    },
                    "stoch": {
                        "fastk_period": 3,
                        "slowk_period": 2,
                        "slowk_matype": 0,
                        "slowd_period": 2,
                        "slowd_matype": 0
                    },
                    "macd": {
                        "fastperiod": 3,
                        "slowperiod": 7,
                        "signalperiod": 2
                    },
                    "ema": {
                        "short_period": 3,
                        "long_period": 7
                    },
                    "atr": {
                        "timeperiod": 3
                    },
                    "bb": {
                        "timeperiod": 20,
                        "nbdevup": 2,
                        "nbdevdn": 2
                    }
                }
            },
            "risk": {
                "max_drawdown_pct": 0.25,
                "stop_loss_pct": 0.03
            }
        }
        
        if os.path.exists(CONFIG_FILE):
            try:
                with open(CONFIG_FILE, 'r', encoding='utf-8') as f:
                    loaded_config = json.load(f)
                # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
                for key, value in default_config.items():
                    if key not in loaded_config:
                        loaded_config[key] = value
                    elif isinstance(value, dict) and isinstance(loaded_config[key], dict):
                        # –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö —Å–ª–æ–≤–∞—Ä–µ–π
                        for sub_key, sub_value in value.items():
                            if sub_key not in loaded_config[key]:
                                loaded_config[key][sub_key] = sub_value
                logger.info(f"‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑ {CONFIG_FILE}")
                return loaded_config
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ {CONFIG_FILE}: {e}. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç–Ω–∞—è.")
                return default_config
        else:
            # –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
            logger.warning(f"‚ö†Ô∏è –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ {CONFIG_FILE} –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞—é –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π.")
            self.save_config(default_config)
            return default_config

    def get_config(self):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"""
        return self.config

    def save_config(self, config_data):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ —Ñ–∞–π–ª"""
        try:
            with open(CONFIG_FILE, 'w', encoding='utf-8') as f:
                json.dump(config_data, f, indent=2, ensure_ascii=False)
            logger.info(f"‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ {CONFIG_FILE}")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ {CONFIG_FILE}: {e}")

    def update_config(self, new_data):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"""
        self.config.update(new_data)
        self.save_config(self.config)


# v2.0 (+–ø—Ä–∞–≤–∫–∏ –∏–∑ –∞–Ω–∞–ª–∏–∑–∞: –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∞–≥—Ä–µ–≥–∞—Ü–∏—è –∫–∞–ø–∏—Ç–∞–ª–∞, working_capital, min_alloc)
"""
–ú–æ–¥—É–ª—å –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞–ø–∏—Ç–∞–ª–∞ –º–µ–∂–¥—É —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏.
v2.0: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞–≥—Ä–µ–≥–∞—Ü–∏—è –∫–∞–ø–∏—Ç–∞–ª–∞ (–±–µ—Ä–µ—Ç—Å—è totalEq 1 —Ä–∞–∑), –¥–æ–±–∞–≤–ª–µ–Ω—ã working_capital –∏ min_alloc.
"""
import logging
import asyncio
import ccxt.async_support as ccxt
from config_manager import ConfigManager

logger = logging.getLogger(__name__)

class CapitalDistributor:
    """
    –ú–æ–¥—É–ª—å –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞–ø–∏—Ç–∞–ª–∞ –º–µ–∂–¥—É —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏.
    v2.0: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞–≥—Ä–µ–≥–∞—Ü–∏—è –∫–∞–ø–∏—Ç–∞–ª–∞, –¥–æ–±–∞–≤–ª–µ–Ω—ã working_capital –∏ min_alloc.
    """

    def __init__(self, exchange: ccxt.Exchange):
        self.ex = exchange
        self.config_manager = ConfigManager()
        self.config = self.config_manager.get_config()

    async def get_total_capital(self) -> float:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –æ–±—â–∏–π –∫–∞–ø–∏—Ç–∞–ª –æ–¥–∏–Ω —Ä–∞–∑ –∏–∑ –±–∞–ª–∞–Ω—Å–∞ USDT.
        v2.0: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è totalEq.
        """
        try:
            # v2.0: –ü–æ–ª—É—á–∞–µ–º –æ–±—â–∏–π –∫–∞–ø–∏—Ç–∞–ª –æ–¥–∏–Ω —Ä–∞–∑, –∫–∞–∫ –≤ –∞–Ω–∞–ª–∏–∑–µ
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º 'type': 'spot' –∫–∞–∫ –≤ –∞–Ω–∞–ª–∏–∑–µ –∏ –æ—Å–Ω–æ–≤–Ω–æ–º –∫–æ–¥–µ –±–æ—Ç–æ–≤
            balance = await self.ex.fetch_balance({'type': 'spot'})
            # logger.debug(f"Raw balance response keys: {list(balance.keys())}")
            # logger.debug(f"Balance total section: {balance.get('total', {})}")

            # v2.0: –ò—Å–ø–æ–ª—å–∑—É–µ–º 'total' -> 'USDT' –∫–∞–∫ –≤ –∞–Ω–∞–ª–∏–∑–µ
            total_usdt = float(balance.get('total', {}).get('USDT', 0.0))
            logger.info(f"üí∞ –û–±—â–∏–π –∫–∞–ø–∏—Ç–∞–ª (totalEq): ${total_usdt:.2f} USDT")
            return total_usdt
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—â–µ–≥–æ –∫–∞–ø–∏—Ç–∞–ª–∞: {e}")
            return 0.0

    async def distribute_for_strategy(self, strategy_type: str, symbols: list) -> dict:
        """
        –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–∞–ø–∏—Ç–∞–ª –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏.
        v2.0: –î–æ–±–∞–≤–ª–µ–Ω—ã working_capital –∏ min_alloc.
        """
        try:
            total_capital = await self.get_total_capital()
            if total_capital <= 0:
                logger.warning("‚ö†Ô∏è –û–±—â–∏–π –∫–∞–ø–∏—Ç–∞–ª —Ä–∞–≤–µ–Ω –Ω—É–ª—é –∏–ª–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª–µ–Ω.")
                return {}

            # v2.0: –†–∞–±–æ—á–∏–π –∫–∞–ø–∏—Ç–∞–ª (50% –æ—Ç –æ–±—â–µ–≥–æ, –∫–∞–∫ –≤ –∞–Ω–∞–ª–∏–∑–µ –∏ BaseTradingBot.run)
            working_capital = total_capital * 0.5
            strategy_share = self.config['capital_split'].get(strategy_type, 0.5)
            allocated_for_strategy = working_capital * strategy_share

            logger.info(f"üí∞ –†–∞–±–æ—á–∏–π –∫–∞–ø–∏—Ç–∞–ª: ${working_capital:.2f} USDT")
            logger.info(f"üìä –î–æ–ª—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ '{strategy_type}': {strategy_share*100:.1f}% -> ${allocated_for_strategy:.2f} USDT")

            # v2.0: –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –ø–∞—Ä—É –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
            min_alloc = self.config.get('min_alloc_usd', 100)

            # –ë–∞–∑–æ–≤–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
            base_allocation = allocated_for_strategy / len(symbols) if symbols else 0

            allocations = {}
            skipped_symbols = []

            for symbol in symbols:
                if base_allocation >= min_alloc:
                    allocations[symbol] = base_allocation
                else:
                    skipped_symbols.append(symbol)
                    logger.warning(f"‚ö†Ô∏è {symbol}: –ü—Ä–æ–ø—É—â–µ–Ω–∞ –∏–∑-–∑–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –≤—ã–¥–µ–ª–µ–Ω–∏—è (${base_allocation:.2f} < ${min_alloc})")

            if skipped_symbols and allocations:
                # –ü–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ—Å—Ç–∞–≤—à–∏–π—Å—è –∫–∞–ø–∏—Ç–∞–ª –º–µ–∂–¥—É –æ—Å—Ç–∞–≤—à–∏–º–∏—Å—è —Å–∏–º–≤–æ–ª–∞–º–∏
                # v2.0: –£—Ç–æ—á–Ω–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
                remaining_to_distribute = sum([base_allocation for _ in skipped_symbols])
                bonus_per_active = remaining_to_distribute / len(allocations) if allocations else 0

                for symbol in allocations:
                    allocations[symbol] += bonus_per_active

                logger.info(f"üîÅ –ü–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ: {len(skipped_symbols)} –ø–∞—Ä –ø—Ä–æ–ø—É—â–µ–Ω–æ, –∫–∞–ø–∏—Ç–∞–ª –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω.")
            elif not allocations:
                 logger.warning(f"‚ö†Ô∏è –ù–∏ –æ–¥–Ω–∞ –ø–∞—Ä–∞ –Ω–µ –ø—Ä–æ—à–ª–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥ –≤—ã–¥–µ–ª–µ–Ω–∏—è –¥–ª—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ '{strategy_type}'.")

            logger.info(f"‚úÖ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è '{strategy_type}' –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –í—Å–µ–≥–æ –ø–∞—Ä: {len(allocations)}, –ü—Ä–æ–ø—É—â–µ–Ω–æ: {len(skipped_symbols)}")
            return allocations

        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞–ø–∏—Ç–∞–ª–∞ –¥–ª—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ '{strategy_type}': {e}")
            return {}

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
# distributor = CapitalDistributor(exchange_instance)
# grid_allocations = await distributor.distribute_for_strategy('grid', ['BTC/USDT', 'ETH/USDT'])


# v2.0 (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)
"""
–ú–æ–¥—É–ª—å –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.
v2.0: –ù–æ–≤—ã–π —Ñ–∞–π–ª –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–æ–≥–∞–º–∏ –±–æ—Ç–æ–≤.
"""
import logging
import os
from logging.handlers import RotatingFileHandler

def build_logger(bot_type: str) -> logging.Logger:
    """
    –°–æ–∑–¥–∞—ë—Ç –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ª–æ–≥–≥–µ—Ä –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–∏–ø–∞ –±–æ—Ç–∞.
    v2.0: –ù–æ–≤—ã–π —Ñ–∞–π–ª –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–æ–≤.
    """
    # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É logs –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
    os.makedirs('logs', exist_ok=True)
    
    # –°–æ–∑–¥–∞–µ–º –ª–æ–≥–≥–µ—Ä —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –±–æ—Ç–∞
    logger = logging.getLogger(f"{bot_type}_logger")
    logger.setLevel(logging.DEBUG)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å
    if not logger.handlers:
        # –°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ñ–∞–π–ª–∞ —Å —Ä–æ—Ç–∞—Ü–∏–µ–π
        log_file = f'logs/{bot_type}_bot.log'
        # RotatingFileHandler —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º 10MB –∏ 5 –±—ç–∫–∞–ø–∞–º–∏
        file_handler = RotatingFileHandler(
            log_file, 
            maxBytes=10*1024*1024,  # 10 MB
            backupCount=5,
            encoding='utf-8'
        )
        file_handler.setLevel(logging.DEBUG)
        
        # –°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏
        console_handler = logging.StreamHandler()
        console_handler.setLevel(logging.INFO)
        
        # –°–æ–∑–¥–∞–µ–º —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä
        formatter = logging.Formatter(
            '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
        )
        file_handler.setFormatter(formatter)
        console_handler.setFormatter(formatter)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫ –ª–æ–≥–≥–µ—Ä—É
        logger.addHandler(file_handler)
        logger.addHandler(console_handler)
        
    return logger


# v2.0 (+–ø—Ä–∞–≤–∫–∏ –∏–∑ –∞–Ω–∞–ª–∏–∑–∞: –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –±–æ—Ç–æ–≤)
"""
Telegram Bot Controller.
v2.0: –î–æ–±–∞–≤–ª–µ–Ω–æ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –±–æ—Ç–æ–≤ —á–µ—Ä–µ–∑ IPC.
"""
import os
import sys
import json
import logging
import subprocess
import signal
import asyncio
import aiohttp
from datetime import datetime, timedelta
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes, MessageHandler, filters
from dotenv import load_dotenv
import ccxt.async_support as ccxt
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º security –∏ config_manager
from security import SecurityManager
from config_manager import ConfigManager
# –ù–æ–≤—ã–π –º–æ–¥—É–ª—å IPC (–ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å)
from ipc import BotIPCClient

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

# === v2.0: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∏–∑ —á–µ–∫-–ª–∏—Å—Ç–∞ ===
# - –î–æ–±–∞–≤–ª–µ–Ω–æ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –±–æ—Ç–æ–≤
# === /v2.0 ===

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler("logs/controller.log", encoding='utf-8'),
        logging.StreamHandler(sys.stdout)
    ]
)
logger = logging.getLogger(__name__)

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
global grid_process, scalp_process
grid_process = None
scalp_process = None

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram –±–æ—Ç–∞
TELEGRAM_TOKEN = os.getenv('TELEGRAM_TOKEN')
if not TELEGRAM_TOKEN:
    raise ValueError("‚ùå TELEGRAM_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∏—Ä–∂–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
EXCHANGE_INSTANCE = None
try:
    API_KEY = os.getenv('API_KEY')
    API_SECRET = os.getenv('API_SECRET')
    PASSPHRASE = os.getenv('PASSPHRASE')
    if API_KEY and API_SECRET and PASSPHRASE:
        EXCHANGE_INSTANCE = ccxt.okx({
            'apiKey': API_KEY,
            'secret': API_SECRET,
            'password': PASSPHRASE,
            'sandbox': True,  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ-—Ä–µ–∂–∏–º
            'enableRateLimit': True,
            'options': {'defaultType': 'spot'}
        })
    else:
        logger.warning("‚ö†Ô∏è API –∫–ª—é—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ .env. –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π –±—É–¥–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ.")
except Exception as e:
    EXCHANGE_INSTANCE = None
    logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –±–∏—Ä–∂–∏ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞: {e}")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
security = SecurityManager('users.json', telegram_token=TELEGRAM_TOKEN)
config_manager = ConfigManager()
CONFIG = config_manager.get_config()
SYMBOLS = CONFIG['symbols']

# IPC –∫–ª–∏–µ–Ω—Ç—ã
grid_ipc = BotIPCClient("http://localhost:8081")
scalp_ipc = BotIPCClient("http://localhost:8082")

async def init_ipc_clients(application):
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è IPC –∫–ª–∏–µ–Ω—Ç–æ–≤"""
    await grid_ipc.start()
    await scalp_ipc.start()
    # application.job_queue.run_once(close_ipc_clients, when=1) # –ó–∞–∫—Ä–æ–µ–º –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏

# async def close_ipc_clients(application):
#     """–ó–∞–∫—Ä—ã—Ç–∏–µ IPC –∫–ª–∏–µ–Ω—Ç–æ–≤"""
#     await grid_ipc.close()
#     await scalp_ipc.close()

# === v2.0: –î–æ–±–∞–≤–ª–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–π —á–µ—Ä–µ–∑ IPC ===
async def close_grid_positions_via_ipc():
    """–ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π Grid-–±–æ—Ç–∞ —á–µ—Ä–µ–∑ IPC"""
    try:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫—É (–∫–æ—Ç–æ—Ä–∞—è –≤–∫–ª—é—á–∞–µ—Ç –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π)
        async with aiohttp.ClientSession() as session:
            async with session.post("http://localhost:8081/stop") as resp:
                if resp.status == 200:
                    logger.info("‚úÖ –ö–æ–º–∞–Ω–¥–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (—Å –∑–∞–∫—Ä—ã—Ç–∏–µ–º –ø–æ–∑–∏—Ü–∏–π) Grid-–±–æ—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ IPC")
                    return True
                else:
                    logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ Grid-–±–æ—Ç–∞ —á–µ—Ä–µ–∑ IPC: HTTP {resp.status}")
                    return False
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ Grid-–±–æ—Ç–∞ —á–µ—Ä–µ–∑ IPC: {e}")
        return False

async def close_scalp_positions_via_ipc():
    """–ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π Scalp-–±–æ—Ç–∞ —á–µ—Ä–µ–∑ IPC"""
    try:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫—É (–∫–æ—Ç–æ—Ä–∞—è –≤–∫–ª—é—á–∞–µ—Ç –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π)
        async with aiohttp.ClientSession() as session:
            async with session.post("http://localhost:8082/stop") as resp:
                if resp.status == 200:
                    logger.info("‚úÖ –ö–æ–º–∞–Ω–¥–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (—Å –∑–∞–∫—Ä—ã—Ç–∏–µ–º –ø–æ–∑–∏—Ü–∏–π) Scalp-–±–æ—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ IPC")
                    return True
                else:
                    logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ Scalp-–±–æ—Ç–∞ —á–µ—Ä–µ–∑ IPC: HTTP {resp.status}")
                    return False
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ Scalp-–±–æ—Ç–∞ —á–µ—Ä–µ–∑ IPC: {e}")
        return False
# === /v2.0: –î–æ–±–∞–≤–ª–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–π —á–µ—Ä–µ–∑ IPC ===

async def monitor_bots(context: ContextTypes.DEFAULT_TYPE):
    """–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–æ—Ç–æ–≤"""
    global grid_process, scalp_process

    status = {
        "grid_status": "–Ω–µ –∑–∞–ø—É—â–µ–Ω",
        "scalp_status": "–Ω–µ –∑–∞–ø—É—â–µ–Ω",
        "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    }

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å Grid –ø—Ä–æ—Ü–µ—Å—Å–∞
    if grid_process:
        if grid_process.poll() is None:
            status["grid_status"] = "–∑–∞–ø—É—â–µ–Ω"
        else:
            status["grid_status"] = f"–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–∫–æ–¥: {grid_process.poll()})"

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å Scalp –ø—Ä–æ—Ü–µ—Å—Å–∞
    if scalp_process:
        if scalp_process.poll() is None:
            status["scalp_status"] = "–∑–∞–ø—É—â–µ–Ω"
        else:
            status["scalp_status"] = f"–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–∫–æ–¥: {scalp_process.poll()})"

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ —Ñ–∞–π–ª –¥–ª—è –¥—Ä—É–≥–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
    try:
        with open('bot_status.json', 'w', encoding='utf-8') as f:
            json.dump(status, f, indent=2, ensure_ascii=False)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: {e}")

def get_bot_status(bot_type):
    """–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞ –∏–∑ –ª–æ–≥-—Ñ–∞–π–ª–∞ (–ó–∞–≥–ª—É—à–∫–∞, –≤ –∏–¥–µ–∞–ª–µ –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å IPC)"""
    try:
        log_file_path = f'logs/{bot_type}_bot.log'
        if os.path.exists(log_file_path):
            with open(log_file_path, 'r', encoding='utf-8') as f:
                lines = f.readlines()
                relevant_lines = []
                for line in reversed(lines[-50:]):  # –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å—Ç—Ä–æ–∫
                    if any(keyword in line for keyword in ["–∑–∞–ø—É—â–µ–Ω", "–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω", "Graceful shutdown", "Error", "Exception", "TP", "SL", "–ø–æ–∑–∏—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∞", "–ø–æ–∑–∏—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞"]):
                        relevant_lines.append(line.strip())
                        if len(relevant_lines) >= 5:
                            break
                if relevant_lines:
                    return "\n".join(relevant_lines[:5])
        return "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è {bot_type}: {e}")
        return f"–û—à–∏–±–∫–∞: {str(e)}"

def get_status():
    """–ü–æ–ª—É—á–∞–µ—Ç –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤"""
    status = {
        "grid_status": "–Ω–µ –∑–∞–ø—É—â–µ–Ω",
        "scalp_status": "–Ω–µ –∑–∞–ø—É—â–µ–Ω",
        "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    }
    global grid_process, scalp_process

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å Grid –ø—Ä–æ—Ü–µ—Å—Å–∞
    if grid_process:
        if grid_process.poll() is None:
            status["grid_status"] = "–∑–∞–ø—É—â–µ–Ω"
        else:
            status["grid_status"] = f"–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–∫–æ–¥: {grid_process.poll()})"

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å Scalp –ø—Ä–æ—Ü–µ—Å—Å–∞
    if scalp_process:
        if scalp_process.poll() is None:
            status["scalp_status"] = "–∑–∞–ø—É—â–µ–Ω"
        else:
            status["scalp_status"] = f"–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–∫–æ–¥: {scalp_process.poll()})"

    return status

# --- –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã ---
def main_menu_keyboard(user_id):
    """–û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é"""
    keyboard = [
        [InlineKeyboardButton("üìâ Multi Grid Bot", callback_data='multi_grid_menu')],
        [InlineKeyboardButton("‚ö° Multi Scalp Bot", callback_data='multi_scalp_menu')],
        [InlineKeyboardButton("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏", callback_data='settings_menu')],
        [InlineKeyboardButton("üìà –ê–Ω–∞–ª–∏–∑", callback_data='analysis_menu')],
    ]
    if security.is_admin(user_id):
        keyboard.append([InlineKeyboardButton("üë• –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ", callback_data='admin_menu')])
    return InlineKeyboardMarkup(keyboard)

def multi_grid_menu_keyboard(user_id):
    """–ú–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Multi Grid Bot"""
    keyboard = [
        [InlineKeyboardButton("‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å Grid", callback_data='start_multi_grid')],
        [InlineKeyboardButton("‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Grid", callback_data='stop_multi_grid')],
        [InlineKeyboardButton("üìä –°—Ç–∞—Ç—É—Å Grid", callback_data='status_multi_grid')],
        [InlineKeyboardButton("‚ÑπÔ∏è –ü–æ–∑–∏—Ü–∏–∏ Grid", callback_data='info_positions_grid')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data='main_menu')]
    ]
    return InlineKeyboardMarkup(keyboard)

def multi_scalp_menu_keyboard(user_id):
    """–ú–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Multi Scalp Bot"""
    keyboard = [
        [InlineKeyboardButton("‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å Scalp", callback_data='start_multi_scalp')],
        [InlineKeyboardButton("‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Scalp", callback_data='stop_multi_scalp')],
        [InlineKeyboardButton("üìä –°—Ç–∞—Ç—É—Å Scalp", callback_data='status_multi_scalp')],
        [InlineKeyboardButton("‚ÑπÔ∏è –ü–æ–∑–∏—Ü–∏–∏ Scalp", callback_data='info_positions_scalp')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data='main_menu')]
    ]
    return InlineKeyboardMarkup(keyboard)

def settings_menu_keyboard():
    """–ú–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫"""
    keyboard = [
        [InlineKeyboardButton("üìâ Grid –Ω–∞—Å—Ç—Ä–æ–π–∫–∏", callback_data='settings_grid_menu')],
        [InlineKeyboardButton("‚ö° Scalp –Ω–∞—Å—Ç—Ä–æ–π–∫–∏", callback_data='settings_scalp_menu')],
        [InlineKeyboardButton("üõ°Ô∏è Risk –Ω–∞—Å—Ç—Ä–æ–π–∫–∏", callback_data='settings_risk_menu')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data='main_menu')]
    ]
    return InlineKeyboardMarkup(keyboard)

def settings_grid_menu_keyboard():
    """–ú–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫ Grid"""
    keyboard = [
        [InlineKeyboardButton("–ú–∏–Ω. –æ—Ä–¥–µ—Ä (USD)", callback_data='edit_grid_min_order_usd')],
        [InlineKeyboardButton("–ú–∞–∫—Å. –ø–æ–∑–∏—Ü–∏—è (USD)", callback_data='edit_grid_max_position_size')],
        [InlineKeyboardButton("–õ–∏–º–∏—Ç —ç–∫—Å–ø–æ–∑–∏—Ü–∏–∏", callback_data='edit_grid_exposure_limit')],
        [InlineKeyboardButton("–ë–∞–∑–æ–≤—ã–π —à–∞–≥", callback_data='edit_grid_base_spacing')],
        [InlineKeyboardButton("–ú–∞–∫—Å. —É—Ä–æ–≤–Ω–µ–π", callback_data='edit_grid_max_levels')],
        [InlineKeyboardButton("–ò–Ω—Ç–µ—Ä–≤–∞–ª (—Å–µ–∫)", callback_data='edit_grid_sleep_interval')],
        [InlineKeyboardButton("–¢–∞–π–º–∞—É—Ç –æ—Ä–¥–µ—Ä–∞ (—Å–µ–∫)", callback_data='edit_grid_order_timeout_seconds')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data='settings_menu')]
    ]
    return InlineKeyboardMarkup(keyboard)

def settings_scalp_menu_keyboard():
    """–ú–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫ Scalp"""
    keyboard = [
        [InlineKeyboardButton("–ú–∏–Ω. –æ—Ä–¥–µ—Ä (USD)", callback_data='edit_scalp_min_order_usd')],
        [InlineKeyboardButton("–ú–∞–∫—Å. –ø–æ–∑–∏—Ü–∏–π", callback_data='edit_scalp_max_positions')],
        [InlineKeyboardButton("–†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ (%)", callback_data='edit_scalp_position_size_percent')],
        [InlineKeyboardButton("–ò–Ω—Ç–µ—Ä–≤–∞–ª (—Å–µ–∫)", callback_data='edit_scalp_sleep_interval')],
        [InlineKeyboardButton("–ü–æ—Ä–æ–≥ —Å–∏–≥–Ω–∞–ª–∞", callback_data='edit_scalp_signal_threshold')],
        [InlineKeyboardButton("TP (%)", callback_data='edit_scalp_take_profit_pct')],
        [InlineKeyboardButton("SL (%)", callback_data='edit_scalp_stop_loss_pct')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data='settings_menu')]
    ]
    return InlineKeyboardMarkup(keyboard)

def settings_risk_menu_keyboard():
    """–ú–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫ Risk"""
    keyboard = [
        [InlineKeyboardButton("–ú–∞–∫—Å. –ø—Ä–æ—Å–∞–¥–∫–∞ (%)", callback_data='edit_risk_max_drawdown_pct')],
        [InlineKeyboardButton("–°—Ç–æ–ø-–ª–æ—Å—Å (%)", callback_data='edit_risk_stop_loss_pct')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data='settings_menu')]
    ]
    return InlineKeyboardMarkup(keyboard)

def analysis_menu_keyboard():
    """–ú–µ–Ω—é –∞–Ω–∞–ª–∏–∑–∞"""
    keyboard = [
        [InlineKeyboardButton("üìâ –ê–Ω–∞–ª–∏–∑ Multi Grid", callback_data='analyze_multi_grid')],
        [InlineKeyboardButton("‚ö° –ê–Ω–∞–ª–∏–∑ Multi Scalp", callback_data='analyze_multi_scalp')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data='main_menu')]
    ]
    return InlineKeyboardMarkup(keyboard)

def admin_menu_keyboard():
    """–ú–µ–Ω—é –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    keyboard = [
        [InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", callback_data='add_user')],
        [InlineKeyboardButton("‚ûñ –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", callback_data='remove_user')],
        [InlineKeyboardButton("üìã –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", callback_data='list_users')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data='main_menu')]
    ]
    return InlineKeyboardMarkup(keyboard)

# --- –•—ç–Ω–¥–ª–µ—Ä—ã ---
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–•—ç–Ω–¥–ª–µ—Ä –∫–æ–º–∞–Ω–¥—ã /start"""
    user_id = update.effective_user.id
    username = update.effective_user.username
    first_name = update.effective_user.first_name
    last_name = update.effective_user.last_name

    if not security.is_authorized(user_id):
        tg_bot = context.bot
        await security.notify_admins(tg_bot, user_id, username, first_name, last_name)
        await update.message.reply_text("üîí –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É–≤–µ–¥–æ–º–ª—ë–Ω.")
        return

    await update.message.reply_text(
        "üéØ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Multi Asset Trading Bot Control Panel!",
        reply_markup=main_menu_keyboard(user_id)
    )

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–•—ç–Ω–¥–ª–µ—Ä callback'–æ–≤ –æ—Ç –∫–Ω–æ–ø–æ–∫"""
    query = update.callback_query
    await query.answer()
    user_id = query.from_user.id
    data = query.data
    message = query.message

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    if not security.is_authorized(user_id):
        await message.edit_text("üîí –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω.", reply_markup=main_menu_keyboard(user_id))
        return

    # –û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é
    if data == 'main_menu':
        await message.edit_text("üéØ Multi Asset Trading Bot Control Panel:", reply_markup=main_menu_keyboard(user_id))

    # Multi Grid Bot —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    elif data == 'multi_grid_menu':
        await message.edit_text("üìâ Multi Asset Grid Bot:", reply_markup=multi_grid_menu_keyboard(user_id))
    elif data == 'start_multi_grid' and security.is_admin(user_id):
        global grid_process
        if grid_process and grid_process.poll() is None:
            await message.reply_text("üìâ Multi Grid —É–∂–µ –∑–∞–ø—É—â–µ–Ω")
        else:
            try:
                # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–∫ subprocess
                grid_process = subprocess.Popen([sys.executable, 'multi_asset_grid_bot.py'])
                await message.reply_text("‚úÖ Multi Asset Grid Bot –∑–∞–ø—É—â–µ–Ω")
                logger.info(f"Multi Asset Grid Bot –∑–∞–ø—É—â–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id}")
            except Exception as e:
                await message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ Multi Grid Bot: {str(e)}")
                logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ Multi Grid Bot: {e}")
    # v2.0: –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ Grid-–±–æ—Ç–∞
    elif data == 'stop_multi_grid' and security.is_admin(user_id):
        global grid_process
        if grid_process and grid_process.poll() is None:
            try:
                # === v2.0: –î–æ–±–∞–≤–ª–µ–Ω–æ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π –ø–µ—Ä–µ–¥ –æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π —á–µ—Ä–µ–∑ IPC ===
                await message.reply_text("üö™ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (—Å –∑–∞–∫—Ä—ã—Ç–∏–µ–º –ø–æ–∑–∏—Ü–∏–π) Grid-–±–æ—Ç—É...")
                success = await close_grid_positions_via_ipc()
                if success:
                    await asyncio.sleep(3)  # –î–∞–µ–º –≤—Ä–µ–º—è –±–æ—Ç—É –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ–º–∞–Ω–¥—É
                    await message.reply_text("‚úÖ –ö–æ–º–∞–Ω–¥–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ Grid-–±–æ—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è...")
                else:
                    await message.reply_text("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ Grid-–±–æ—Ç—É —á–µ—Ä–µ–∑ IPC. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∫—É –ø—Ä–æ—Ü–µ—Å—Å–∞.")
                # === /v2.0: –î–æ–±–∞–≤–ª–µ–Ω–æ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π ===

                grid_process.terminate()
                try:
                    grid_process.wait(timeout=20) # –£–≤–µ–ª–∏—á–∏–ª —Ç–∞–π–º–∞—É—Ç
                except subprocess.TimeoutExpired:
                    grid_process.kill()
                    grid_process.wait()
                grid_process = None
                await message.reply_text("‚úÖ Multi Asset Grid Bot –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
                logger.info(f"Multi Asset Grid Bot –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id}")
            except Exception as e:
                # –ù–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω –∏–ª–∏ –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞
                if grid_process and grid_process.poll() is None:
                    grid_process.kill()
                    grid_process.wait()
                grid_process = None
                await message.reply_text(f"‚ö†Ô∏è Multi Asset Grid Bot –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (—Å –æ—à–∏–±–∫–æ–π): {str(e)}")
                logger.error(f"–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ Multi Grid Bot: {e}")
        else:
            await message.reply_text("‚ö†Ô∏è Multi Asset Grid Bot –Ω–µ –∑–∞–ø—É—â–µ–Ω!")
    elif data == 'status_multi_grid':
        # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 3: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ IPC -
        status = await grid_ipc.get_status()
        if "error" not in status:
            msg = f"üìâ Multi Grid Bot Status:\n"
            msg += f"Status: {status.get('status', 'unknown')}\n"
            msg += f"Equity: ${status.get('equity', 0):.2f}\n"
            msg += f"Positions: {len(status.get('positions', []))}"
        else:
            msg = f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: {status['error']}"
        await message.reply_text(msg)
        # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 3 -
    # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 3: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–∑–∏—Ü–∏—è—Ö Grid -
    elif data == 'info_positions_grid':
        await message.reply_text("üìä –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–∑–∏—Ü–∏—è—Ö Grid... ")
        positions_info = await get_positions_info('grid')
        await message.reply_text(positions_info)
        # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 3 -

    # Multi Scalp Bot —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    elif data == 'multi_scalp_menu':
        await message.edit_text("‚ö° Multi Asset Scalp Bot:", reply_markup=multi_scalp_menu_keyboard(user_id))
    elif data == 'start_multi_scalp' and security.is_admin(user_id):
        global scalp_process
        if scalp_process and scalp_process.poll() is None:
            await message.reply_text("‚ö° Multi Scalp —É–∂–µ –∑–∞–ø—É—â–µ–Ω")
        else:
            try:
                # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–∫ subprocess
                scalp_process = subprocess.Popen([sys.executable, 'multi_asset_scalp_bot.py'])
                await message.reply_text("‚úÖ Multi Asset Scalp Bot –∑–∞–ø—É—â–µ–Ω")
                logger.info(f"Multi Asset Scalp Bot –∑–∞–ø—É—â–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id}")
            except Exception as e:
                await message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ Multi Scalp Bot: {str(e)}")
                logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ Multi Scalp Bot: {e}")
    # v2.0: –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ Scalp-–±–æ—Ç–∞
    elif data == 'stop_multi_scalp' and security.is_admin(user_id):
        global scalp_process
        if scalp_process and scalp_process.poll() is None:
            try:
                # === v2.0: –î–æ–±–∞–≤–ª–µ–Ω–æ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π –ø–µ—Ä–µ–¥ –æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π —á–µ—Ä–µ–∑ IPC ===
                await message.reply_text("üö™ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (—Å –∑–∞–∫—Ä—ã—Ç–∏–µ–º –ø–æ–∑–∏—Ü–∏–π) Scalp-–±–æ—Ç—É...")
                success = await close_scalp_positions_via_ipc()
                if success:
                    await asyncio.sleep(3)  # –î–∞–µ–º –≤—Ä–µ–º—è –±–æ—Ç—É –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ–º–∞–Ω–¥—É
                    await message.reply_text("‚úÖ –ö–æ–º–∞–Ω–¥–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ Scalp-–±–æ—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è...")
                else:
                    await message.reply_text("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ Scalp-–±–æ—Ç—É —á–µ—Ä–µ–∑ IPC. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∫—É –ø—Ä–æ—Ü–µ—Å—Å–∞.")
                # === /v2.0: –î–æ–±–∞–≤–ª–µ–Ω–æ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π ===

                scalp_process.terminate()
                try:
                    scalp_process.wait(timeout=20) # –£–≤–µ–ª–∏—á–∏–ª —Ç–∞–π–º–∞—É—Ç
                except subprocess.TimeoutExpired:
                    scalp_process.kill()
                    scalp_process.wait()
                scalp_process = None
                await message.reply_text("üõë Multi Asset Scalp Bot –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
                logger.info(f"Multi Asset Scalp Bot –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id}")
            except Exception as e:
                # –ù–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω –∏–ª–∏ –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞
                if scalp_process and scalp_process.poll() is None:
                    scalp_process.kill()
                    scalp_process.wait()
                scalp_process = None
                await message.reply_text(f"‚ö†Ô∏è Multi Asset Scalp Bot –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (—Å –æ—à–∏–±–∫–æ–π): {str(e)}")
                logger.error(f"–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ Multi Scalp Bot: {e}")
        else:
            await message.reply_text("‚ö†Ô∏è Multi Asset Scalp Bot –Ω–µ –∑–∞–ø—É—â–µ–Ω!")
    elif data == 'status_multi_scalp':
        # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 3: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ IPC -
        status = await scalp_ipc.get_status()
        if "error" not in status:
            msg = f"‚ö° Multi Scalp Bot Status:\n"
            msg += f"Status: {status.get('status', 'unknown')}\n"
            msg += f"Equity: ${status.get('equity', 0):.2f}\n"
            msg += f"Positions: {len(status.get('positions', []))}"
        else:
            msg = f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: {status['error']}"
        await message.reply_text(msg)
        # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 3 -
    # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 3: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–∑–∏—Ü–∏—è—Ö Scalp -
    elif data == 'info_positions_scalp':
        await message.reply_text("‚ö° –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–∑–∏—Ü–∏—è—Ö Scalp... ")
        positions_info = await get_positions_info('scalp')
        await message.reply_text(positions_info)
        # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 3 -

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    elif data == 'settings_menu':
        await message.edit_text("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–æ–≤:", reply_markup=settings_menu_keyboard())
    elif data == 'settings_grid_menu':
        await message.edit_text("üìâ Grid –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:", reply_markup=settings_grid_menu_keyboard())
    elif data == 'settings_scalp_menu':
        await message.edit_text("‚ö° Scalp –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:", reply_markup=settings_scalp_menu_keyboard())
    elif data == 'settings_risk_menu':
        await message.edit_text("üõ°Ô∏è Risk –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:", reply_markup=settings_risk_menu_keyboard())
    # - –ü–û–î–ì–û–¢–û–í–ö–ê (–ü—É–Ω–∫—Ç 2): –î–æ–±–∞–≤–ª–µ–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ FSM -
    elif data.startswith('edit_grid_'):
        param_name = data.replace('edit_grid_', '')
        await message.reply_text(f"‚öôÔ∏è –§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è {param_name} –¥–ª—è Grid –±–æ—Ç–∞.\n(–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (FSM) –µ—â–µ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ —ç—Ç–æ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ. –î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞, –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –¥–æ—Ä–∞–±–æ—Ç–∞–π—Ç–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä.)")
    # - /–ü–û–î–ì–û–¢–û–í–ö–ê (–ü—É–Ω–∫—Ç 2) -
    # - –ü–û–î–ì–û–¢–û–í–ö–ê (–ü—É–Ω–∫—Ç 2): –î–æ–±–∞–≤–ª–µ–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ FSM -
    elif data.startswith('edit_scalp_'):
        param_name = data.replace('edit_scalp_', '')
        await message.reply_text(f"‚öôÔ∏è –§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è {param_name} –¥–ª—è Scalp –±–æ—Ç–∞.\n(–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (FSM) –µ—â–µ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ —ç—Ç–æ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ. –î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞, –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –¥–æ—Ä–∞–±–æ—Ç–∞–π—Ç–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä.)")
    # - /–ü–û–î–ì–û–¢–û–í–ö–ê (–ü—É–Ω–∫—Ç 2) -
    elif data.startswith('edit_risk_'):
        param_name = data.replace('edit_risk_', '')
        await message.reply_text(f"‚öôÔ∏è –§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è {param_name}.\n(–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (FSM) –µ—â–µ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ —ç—Ç–æ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ. –î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞, –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –¥–æ—Ä–∞–±–æ—Ç–∞–π—Ç–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä.)")

    # –ê–Ω–∞–ª–∏–∑
    elif data == 'analysis_menu':
        await message.edit_text("üìà –ê–Ω–∞–ª–∏–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:", reply_markup=analysis_menu_keyboard())
    elif data == 'analyze_multi_grid':
        await message.reply_text("üìä –ê–Ω–∞–ª–∏–∑ Multi Grid –±–æ—Ç–∞ –∑–∞–ø—É—â–µ–Ω...")
        try:
            result = subprocess.run([sys.executable, 'multi_analyze_stats.py', 'grid'], capture_output=True, text=True, timeout=45)
            if result.returncode == 0:
                await message.reply_text(f"‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω:\n<pre>{result.stdout}</pre>", parse_mode='HTML')
            else:
                await message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞:\n<pre>{result.stderr}</pre>", parse_mode='HTML')
        except subprocess.TimeoutExpired:
            await message.reply_text("‚è∞ –ê–Ω–∞–ª–∏–∑ –ø—Ä–µ–≤—ã—Å–∏–ª –ª–∏–º–∏—Ç –≤—Ä–µ–º–µ–Ω–∏ (45 —Å–µ–∫—É–Ω–¥)")
        except Exception as e:
            await message.reply_text(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: {e}")
    elif data == 'analyze_multi_scalp':
        await message.reply_text("‚ö° –ê–Ω–∞–ª–∏–∑ Multi Scalp –±–æ—Ç–∞ –∑–∞–ø—É—â–µ–Ω...")
        try:
            result = subprocess.run([sys.executable, 'multi_analyze_stats.py', 'scalp'], capture_output=True, text=True, timeout=45)
            if result.returncode == 0:
                await message.reply_text(f"‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω:\n<pre>{result.stdout}</pre>", parse_mode='HTML')
            else:
                await message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞:\n<pre>{result.stderr}</pre>", parse_mode='HTML')
        except subprocess.TimeoutExpired:
            await message.reply_text("‚è∞ –ê–Ω–∞–ª–∏–∑ –ø—Ä–µ–≤—ã—Å–∏–ª –ª–∏–º–∏—Ç –≤—Ä–µ–º–µ–Ω–∏ (45 —Å–µ–∫—É–Ω–¥)")
        except Exception as e:
            await message.reply_text(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: {e}")

    # –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
    elif data == 'admin_menu':
        if security.is_admin(user_id):
            await message.edit_text("üë• –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ:", reply_markup=admin_menu_keyboard())
        else:
            await message.edit_text("üö´ –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω.", reply_markup=main_menu_keyboard(user_id))
    elif data == 'add_user' and security.is_admin(user_id):
        await message.reply_text("–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, /add_user 123456789):")
    elif data == 'remove_user' and security.is_admin(user_id):
        await message.reply_text("–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, /remove_user 123456789):")
    elif data == 'list_users' and security.is_admin(user_id):
        users = security.get_users()
        if users:
            user_list = "\n".join([f"ID: {u}" for u in users])
            await message.reply_text(f"üìã –°–ø–∏—Å–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:\n{user_list}")
        else:
            await message.reply_text("üìã –°–ø–∏—Å–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—É—Å—Ç.")

async def handle_text_input(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–¥–ª—è –∞–¥–º–∏–Ω—Å–∫–∏—Ö –∫–æ–º–∞–Ω–¥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)"""
    user_id = update.effective_user.id
    if not security.is_admin(user_id):
        return

    text = update.message.text.strip()
    if text.startswith('/add_user'):
        try:
            parts = text.split()
            if len(parts) != 2:
                raise ValueError("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã")
            new_user_id = int(parts[1])
            security.add_user(new_user_id)
            await update.message.reply_text(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {new_user_id} –¥–æ–±–∞–≤–ª–µ–Ω.")
            logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {new_user_id} –¥–æ–±–∞–≤–ª–µ–Ω –∞–¥–º–∏–Ω–æ–º {user_id}")
        except Exception as e:
            await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
    elif text.startswith('/remove_user'):
        try:
            parts = text.split()
            if len(parts) != 2:
                raise ValueError("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã")
            remove_user_id = int(parts[1])
            security.remove_user(remove_user_id)
            await update.message.reply_text(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {remove_user_id} —É–¥–∞–ª–µ–Ω.")
            logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {remove_user_id} —É–¥–∞–ª–µ–Ω –∞–¥–º–∏–Ω–æ–º {user_id}")
        except Exception as e:
            await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")

# - –î–û–ë–ê–í–õ–ï–ù–ò–ï 1: –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–∑–∏—Ü–∏—è—Ö -
async def get_positions_info(bot_type):
    """–ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∑–∏—Ü–∏—è—Ö –∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ—Ä–¥–µ—Ä–∞—Ö –Ω–∞–ø—Ä—è–º—É—é —Å –±–∏—Ä–∂–∏"""
    info_text = ""
    try:
        if not EXCHANGE_INSTANCE:
            return "‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ: API –∫–ª—é—á–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ."
        await EXCHANGE_INSTANCE.load_markets()

        if bot_type == 'grid':
            info_text += "üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–∑–∏—Ü–∏—è—Ö Grid –±–æ—Ç–∞: "
            balances = await EXCHANGE_INSTANCE.fetch_balance()
            positions_found = False
            for symbol in SYMBOLS:
                base_currency = symbol.split('/')[0]
                quote_currency = symbol.split('/')[1]
                base_balance = balances['total'].get(base_currency, 0)
                quote_balance = balances['total'].get(quote_currency, 0)
                if base_balance > 1e-8 or quote_balance > 1e-8:
                    info_text += f"\n{symbol}: {base_balance:.6f} {base_currency} + {quote_balance:.2f} {quote_currency}"
                    positions_found = True

            # –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤
            orders_found = False
            for symbol in SYMBOLS:
                try:
                    orders = await EXCHANGE_INSTANCE.fetch_open_orders(symbol)
                    if orders:
                        orders_found = True
                        info_text += f"\n\n–ê–∫—Ç–∏–≤–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞ –¥–ª—è {symbol}:"
                        for order in orders:
                            side = order['side']
                            price = order['price']
                            amount = order['amount']
                            info_text += f"\n  - {side.upper()} {amount:.6f} @ {price:.2f}"
                except Exception as e:
                    pass
            if not orders_found:
                info_text += "\n–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤."

        elif bot_type == 'scalp':
            info_text += "‚ö° –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–∑–∏—Ü–∏—è—Ö Scalp –±–æ—Ç–∞: "
            balances = await EXCHANGE_INSTANCE.fetch_balance()
            positions_found = False
            for symbol in SYMBOLS:
                base_currency = symbol.split('/')[0]
                quote_currency = symbol.split('/')[1]
                base_balance = balances['total'].get(base_currency, 0)
                quote_balance = balances['total'].get(quote_currency, 0)
                if base_balance > 1e-8 or quote_balance > 1e-8:
                    info_text += f"\n{symbol}: {base_balance:.6f} {base_currency} + {quote_balance:.2f} {quote_currency}"
                    positions_found = True

            # –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤
            orders_found = False
            for symbol in SYMBOLS:
                try:
                    orders = await EXCHANGE_INSTANCE.fetch_open_orders(symbol)
                    if orders:
                        orders_found = True
                        info_text += f"\n\n–ê–∫—Ç–∏–≤–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞ –¥–ª—è {symbol}:"
                        for order in orders:
                            side = order['side']
                            price = order['price']
                            amount = order['amount']
                            info_text += f"\n  - {side.upper()} {amount:.6f} @ {price:.2f}"
                except Exception as e:
                    pass
            if not orders_found:
                info_text += "\n–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤."

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–∑–∏—Ü–∏—è—Ö –¥–ª—è {bot_type}: {e}")
        return f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: {str(e)}"

    return info_text.strip()
# - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 1 -

async def add_user_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /add_user"""
    user_id = update.effective_user.id
    if not security.is_admin(user_id):
        await update.message.reply_text("üîí –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω.")
        return
    await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, /add_user 123456789):")

async def remove_user_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /remove_user"""
    user_id = update.effective_user.id
    if not security.is_admin(user_id):
        await update.message.reply_text("üîí –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω.")
        return
    await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, /remove_user 123456789):")

# --- –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ ---
async def main():
    if not os.path.exists('.env'):
        print("‚ùå –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        print("–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env —Å –≤–∞—à–∏–º–∏ API –∫–ª—é—á–∞–º–∏")
        return

    app = Application.builder().token(TELEGRAM_TOKEN).build()

    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("add_user", add_user_command))
    app.add_handler(CommandHandler("remove_user", remove_user_command))

    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback'–æ–≤ –æ—Ç –∫–Ω–æ–ø–æ–∫
    app.add_handler(CallbackQueryHandler(button_handler))

    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–¥–ª—è –∞–¥–º–∏–Ω—Å–∫–∏—Ö –∫–æ–º–∞–Ω–¥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text_input))

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è IPC –∫–ª–∏–µ–Ω—Ç–æ–≤
    # await init_ipc_clients(app) # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è IPC –∫–ª–∏–µ–Ω—Ç–æ–≤

    # –î–æ–±–∞–≤–ª—è–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
    app.job_queue.run_repeating(monitor_bots, interval=45, first=10)

    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    logger.info("üéØ Multi Asset Bot Controller –∑–∞–ø—É—â–µ–Ω")
    await app.run_polling()

if __name__ == '__main__':
    asyncio.run(main())


# v2.0 (+–ø—Ä–∞–≤–∫–∏ –∏–∑ –∞–Ω–∞–ª–∏–∑–∞: –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞, –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ª–æ–≥–æ–≤, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è, capital_distributor)
"""
–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è —Ç–æ—Ä–≥–æ–≤—ã—Ö –±–æ—Ç–æ–≤.
v2.0: –î–æ–±–∞–≤–ª–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞, –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ª–æ–≥–æ–≤, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω check_min_lot, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è capital_distributor.
"""
import ccxt.async_support as ccxt
import asyncio
import time
import logging
import signal
import os
import sys
import json
import math
import collections
from datetime import datetime, timedelta
from telegram import Bot
from dotenv import load_dotenv
# - –î–û–ë–ê–í–õ–ï–ù–ò–ï 1: –ò–º–ø–æ—Ä—Ç log_helper -
from log_helper import build_logger
# - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 1 -
# - –î–û–ë–ê–í–õ–ï–ù–ò–ï 2: –ò–º–ø–æ—Ä—Ç ConfigManager -
from config_manager import ConfigManager
# - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 2 -
# - –î–û–ë–ê–í–õ–ï–ù–ò–ï 4: –ò–º–ø–æ—Ä—Ç dataclasses –¥–ª—è TradeEvent -
from dataclasses import dataclass
# - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 4 -

load_dotenv()
os.makedirs('logs', exist_ok=True)

# === v2.0: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∏–∑ —á–µ–∫-–ª–∏—Å—Ç–∞ ===
# - –î–æ–±–∞–≤–ª–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
# - –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ª–æ–≥–æ–≤
# - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ check_min_lot (–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1)
# - –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –º–µ—Ç–æ–¥ close_all_positions –¥–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
# === /v2.0 ===

# - –î–û–ë–ê–í–õ–ï–ù–ò–ï 4: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ TradeEvent -
@dataclass
class TradeEvent:
    """–°–æ–±—ã—Ç–∏–µ —Å–¥–µ–ª–∫–∏"""
    ts: float
    symbol: str
    side: str  # buy/sell
    price: float
    qty: float
    pnl: float = 0.0
# - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 4 -

class BaseTradingBot:
    """
    –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è —Ç–æ—Ä–≥–æ–≤—ã—Ö –±–æ—Ç–æ–≤.
    v2.0: –î–æ–±–∞–≤–ª–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞, –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ª–æ–≥–æ–≤, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω check_min_lot, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è capital_distributor.
    """

    def __init__(self, bot_type: str):
        """
        –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è —Ç–æ—Ä–≥–æ–≤—ã—Ö –±–æ—Ç–æ–≤.
        :param bot_type: –¢–∏–ø –±–æ—Ç–∞ ('grid' –∏–ª–∏ 'scalp')
        """
        self.bot_type = bot_type
        
        # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 1: –ò—Å–ø–æ–ª—å–∑—É–µ–º log_helper –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ª–æ–≥-—Ñ–∞–π–ª–∞ -
        self.logger = build_logger(f"{bot_type}_bot")
        # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 1 -
        
        # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 2: –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ ConfigManager -
        self.config_manager = ConfigManager()
        self.config = self.config_manager.get_config()
        # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 2 -
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∏—Ä–∂–∏
        API_KEY = os.getenv('API_KEY')
        API_SECRET = os.getenv('API_SECRET')
        PASSPHRASE = os.getenv('PASSPHRASE')
        if not all([API_KEY, API_SECRET, PASSPHRASE]):
            raise ValueError("‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (API_KEY, API_SECRET, PASSPHRASE)")
            
        self.ex = ccxt.okx({
            'apiKey': API_KEY,
            'secret': API_SECRET,
            'password': PASSPHRASE,
            'enableRateLimit': True,
            'options': {'defaultType': 'spot'},
            'sandbox': True  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ-—Ä–µ–∂–∏–º
        })
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram –±–æ—Ç–∞
        TELEGRAM_TOKEN = os.getenv('TELEGRAM_TOKEN')
        if not TELEGRAM_TOKEN:
            raise ValueError("‚ùå TELEGRAM_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env")
        self.tg_bot = Bot(token=TELEGRAM_TOKEN)
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
        self.symbols = self.config.get('symbols', ['BTC/USDT', 'ETH/USDT', 'BNB/USDT', 'SOL/USDT', 'XRP/USDT', 'ADA/USDT', 'DOT/USDT'])
        self.chat_ids = self.config.get('chat_ids', [462885677, 5954433829])
        
        # –°–æ—Å—Ç–æ—è–Ω–∏–µ –±–æ—Ç–∞
        self.running = True
        self.last_notification = 0
        
        # –ö–∞–ø–∏—Ç–∞–ª
        self.total_capital = 0
        self.working_capital = 0
        self.reserve_capital = 0
        self.allocated_capital = {}  # {symbol: float}
        self.last_redistribution = 0
        self.redistribution_interval = self.config.get('redistribution_interval', 1800)  # 30 –º–∏–Ω—É—Ç
        
        # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 6: –ë—É—Ñ–µ—Ä –¥–ª—è —Å–¥–µ–ª–æ–∫ –∑–∞ 24 —á–∞—Å–∞ -
        self.trades_24h: list[TradeEvent] = []
        # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 6 -
        
        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–∏–≥–Ω–∞–ª–æ–≤
        signal.signal(signal.SIGINT, self.exit_gracefully)
        signal.signal(signal.SIGTERM, self.exit_gracefully)
        
        # === v2.0: –î–æ–±–∞–≤–ª–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ ===
        self._balance_cache = {'data': None, 'time': 0}
        # === /v2.0: –î–æ–±–∞–≤–ª–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ ===
        
        # === v2.0: –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ª–æ–≥–æ–≤ ===
        self._last_log_msg = ""
        # === /v2.0: –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ª–æ–≥–æ–≤ ===

    async def send(self, msg):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram"""
        now = time.time()
        if now - self.last_notification < 2:
            await asyncio.sleep(2 - (now - self.last_notification))
        self.last_notification = now
        for cid in self.chat_ids:
            try:
                await self.tg_bot.send_message(chat_id=cid, text=msg)
            except Exception as e:
                self.logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram: {e}")

    # === v2.0: –û–±–Ω–æ–≤–ª–µ–Ω –º–µ—Ç–æ–¥ get_balances —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º ===
    async def get_balances(self):
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–≤ –¥–ª—è –≤—Å–µ—Ö —Å–∏–º–≤–æ–ª–æ–≤ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º.
        v2.0: –î–æ–±–∞–≤–ª–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ —Å TTL –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞.
        """
        # === v2.0: –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à –±–∞–ª–∞–Ω—Å–∞ ===
        cache_ttl = self.config.get('balance_cache_sec', 60)
        current_time = time.time()
        
        if (self._balance_cache['data'] is not None and
            current_time - self._balance_cache['time'] < cache_ttl):
            self.logger.debug("üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –∫—ç—à –±–∞–ª–∞–Ω—Å–∞")
            return self._balance_cache['data']
        # === /v2.0: –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à –±–∞–ª–∞–Ω—Å–∞ ===
        
        try:
            # - –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1: –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å –û–î–ò–ù –†–ê–ó -
            bal = await self.ex.fetch_balance({'type': 'spot'})
            # - /–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1 -
            balances = {}
            for symbol in self.symbols:
                base_currency = symbol.split('/')[0]
                quote_currency = symbol.split('/')[1]
                base_free = bal['free'].get(base_currency, 0)
                base_total = bal['total'].get(base_currency, 0)
                quote_free = bal['free'].get(quote_currency, 0)
                quote_total = bal['total'].get(quote_currency, 0)
                balances[symbol] = {
                    'base': base_total,
                    'quote': quote_total,
                    'free_base': base_free,
                    'free_quote': quote_free
                }
            # === v2.0: –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à ===
            self._balance_cache['data'] = balances
            self._balance_cache['time'] = current_time
            # === /v2.0: –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à ===
            return balances
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–≤: {e}")
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å –∏–ª–∏ —Å—Ç–∞—Ä—ã–π –∫—ç—à –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏?
            return self._balance_cache['data'] if self._balance_cache['data'] else {}
    # === /v2.0: –û–±–Ω–æ–≤–ª–µ–Ω –º–µ—Ç–æ–¥ get_balances ===

    async def update_capital(self):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–∞–ø–∏—Ç–∞–ª–µ"""
        try:
            balances = await self.get_balances()
            self.total_capital = 0
            for symbol in self.symbols:
                symbol_balance = balances.get(symbol, {'base': 0, 'quote': 0})
                try:
                    ticker = await self.ex.fetch_ticker(symbol)
                    price = ticker['last']
                    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —ç–∫–≤–∏—Ç–∏ –¥–ª—è —Å–∏–º–≤–æ–ª–∞: (–±–∞–∑–æ–≤—ã–π –∞–∫—Ç–∏–≤ * —Ü–µ–Ω–∞) + –∫–æ—Ç–∏—Ä—É–µ–º–∞—è –≤–∞–ª—é—Ç–∞
                    base_equity = symbol_balance['base'] * price
                    quote_equity = symbol_balance['quote']
                    equity = base_equity + quote_equity
                    self.total_capital += equity
                    # - –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -
                    self.logger.debug(f"üí∞ {symbol}: {symbol_balance['base']:.6f} {symbol.split('/')[0]} + {symbol_balance['quote']:.2f} {symbol.split('/')[1]} ‚âà {equity:.2f} USDT")
                    # - /–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2 -
                except Exception as e:
                    self.logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ü–µ–Ω—É –¥–ª—è {symbol} –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–∞–ø–∏—Ç–∞–ª–∞: {e}")
            
            self.logger.info(f"üí∞ –û–±–Ω–æ–≤–ª–µ–Ω –∫–∞–ø–∏—Ç–∞–ª: –í—Å–µ–≥–æ=${self.total_capital:.2f} USDT")
        except Exception as e:
            self.logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–ø–∏—Ç–∞–ª–∞: {e}")
    # - /–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï -

    # - –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1: –ó–∞—â–∏—Ç–∞ –º–µ—Ç–æ–¥–∞ check_min_lot –æ—Ç NoneType -
    async def check_min_lot(self, symbol, amount, price):
        """
        –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –±–∏—Ä–∂–∏ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç None.
        v2.0: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ —Å None market_info (–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1).
        """
        try:
            # 1. –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä—ã–Ω–∫–µ
            market_info = self.ex.market(symbol)
            
            # === v2.0: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1 - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç None ===
            if not market_info:
                self.logger.warning(f"‚ö†Ô∏è {symbol}: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä—ã–Ω–∫–µ")
                return False
            # === /v2.0: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1 ===
            
            # 2. –ü–æ–ª—É—á–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ä—ã–Ω–∫–∞
            min_amount = market_info.get('limits', {}).get('amount', {}).get('min', 0)
            min_cost = market_info.get('limits', {}).get('cost', {}).get('min', 0)
            
            # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–º
            if amount < min_amount:
                self.logger.info(f"‚ö†Ô∏è {symbol}: –û–±—ä–µ–º {amount} < –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ {min_amount}")
                return False
                
            # 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
            cost = amount * price
            if cost < min_cost:
                self.logger.info(f"‚ö†Ô∏è {symbol}: –°—Ç–æ–∏–º–æ—Å—Ç—å {cost:.4f} < –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π {min_cost}")
                return False
                
            return True
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –ª–æ—Ç–∞ –¥–ª—è {symbol}: {e}")
            return False # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Å—á–∏—Ç–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–π
    # - /–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1 -

    # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 1: –ú–µ—Ç–æ–¥ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–¥–µ–ª–æ–∫ -
    async def log_trade(self, event: TradeEvent):
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏. v2.0: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è."""
        msg = (f"{event.symbol} <b>{'–û–¢–ö–†–´–¢–ò–ï' if event.pnl == 0 else '–ó–ê–ö–†–´–¢–ò–ï'}</b>\n"
               f"üí∞ –¶–µ–Ω–∞: <code>{event.price:.4f}</code>\n"
               f"üì¶ –û–±—ä—ë–º: <code>{event.qty:.4f}</code>")
        if event.pnl != 0:
            msg += f"\nüìä PnL: <code>{event.pnl:.2f}</code> $"
            
        # === v2.0: –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ª–æ–≥–æ–≤ ===
        if msg == self._last_log_msg:
            return # –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–¥—Ä—è–¥
        self._last_log_msg = msg
        # === /v2.0: –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ª–æ–≥–æ–≤ ===
            
        self.logger.info(msg.replace('<b>', '').replace('</code>', ''))
        await self.send(msg)
        
        # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 6: –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–¥–µ–ª–∫—É –≤ –±—É—Ñ–µ—Ä -
        self.trades_24h.append(event)
        # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 6 -
    # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 1 -

    # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 11: –ú–µ—Ç–æ–¥ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–Ω–∞–ø—à–æ—Ç–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è -
    async def _log_portfolio_snapshot(self):
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–Ω–∞–ø—à–æ—Ç–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è"""
        try:
            balances = await self.get_balances()
            lines = [f"üìà <b>–ü–æ—Ä—Ç—Ñ–µ–ª—å {self.bot_type.upper()}</b> {datetime.utcnow():%d.%m %H:%M} UTC"]
            total_eq = 0
            for s in self.symbols:
                base, quote = balances[s]['base'], balances[s]['quote']
                try:
                    price = (await self.ex.fetch_ticker(s))['last']
                    eq = base * price + quote
                    total_eq += eq
                    lines.append(f"{s}: {base:.4f} + {quote:.2f} ‚âà <code>{eq:.2f}</code> $")
                except Exception as e:
                    self.logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ü–µ–Ω—É –¥–ª—è {s} –≤ —Å–Ω–∞–ø—à–æ—Ç–µ: {e}")
                    lines.append(f"{s}: {base:.4f} + {quote:.2f} (–¶–µ–Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞)")
            lines.append(f"üí∞ –í—Å–µ–≥–æ: <code>{total_eq:.2f}</code> $")
            msg = "\n".join(lines)
            self.logger.info(msg.replace('<b>', '').replace('</b>', '').replace('<code>', '').replace('</code>', ''))
            await self.send(msg)
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–Ω–∞–ø—à–æ—Ç–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è: {e}")
    # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 11 -

    # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 12: –ú–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ -
    async def _send_daily_summary(self):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞"""
        try:
            # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 6: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–¥–µ–ª–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞ -
            trades = self.trades_24h
            total, wins, losses = len(trades), 0, 0
            gross_pnl = 0.0
            for t in trades:
                gross_pnl += t.pnl
                if t.pnl > 0:
                    wins += 1
                else:
                    losses += 1
            win_rate = wins / total * 100 if total else 0
            # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 6 -
            await self.update_capital()
            msg = (f"üìä <b>–û—Ç—á—ë—Ç –∑–∞ {datetime.utcnow():%d.%m.%Y}</b>\n"
                   f"üí∞ Equity: <code>{self.total_capital:.2f}</code> $\n"
                   f"üìà –°–¥–µ–ª–æ–∫: {total} (W: {wins} / L: {losses})\n"
                   f"üéØ –í–∏–Ω-—Ä–µ–π—Ç: {win_rate:.1f}%\n"
                   f"üíµ PnL: <code>{gross_pnl:.2f}</code> $")
            self.logger.info(msg.replace('<b>', '').replace('</b>', '').replace('<code>', '').replace('</code>', ''))
            await self.send(msg)
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞: {e}")
    # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 12 -

    # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 13: –¶–∏–∫–ª –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ -
    async def _daily_report_loop(self):
        """–¶–∏–∫–ª –æ—Ç–ø—Ä–∞–≤–∫–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞"""
        while self.running:
            # –ñ–¥–µ–º –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ–ª–Ω–æ—á–∏ UTC
            now = datetime.utcnow()
            next_midnight = (now + timedelta(days=1)).replace(hour=0, minute=0, second=0, microsecond=0)
            sleep_seconds = (next_midnight - now).total_seconds()
            self.logger.info(f"–°–ª–µ–¥—É—é—â–∏–π –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç —á–µ—Ä–µ–∑ {sleep_seconds / 3600:.2f} —á–∞—Å–æ–≤")
            await asyncio.sleep(sleep_seconds)
            if not self.running:
                break
            await self._send_daily_summary()
            self.trades_24h.clear() # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 6: –û—á–∏—â–∞–µ–º –±—É—Ñ–µ—Ä –ø–æ—Å–ª–µ –æ—Ç—á–µ—Ç–∞ -
    # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 13 -

    async def distribute_capital(self):
        """
        –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞–ø–∏—Ç–∞–ª–∞. –î–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ –¥–æ—á–µ—Ä–Ω–∏—Ö –∫–ª–∞—Å—Å–∞—Ö.
        v2.0: –û–±–Ω–æ–≤–ª–µ–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.
        """
        self.logger.info(f"üîÑ –ù–∞—á–∞–ª–æ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞–ø–∏—Ç–∞–ª–∞ –¥–ª—è {self.bot_type}...")
        # –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è: —Ä–∞–≤–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
        total_allocated = 0
        base_capital_per_symbol = self.working_capital / len(self.symbols)
        for symbol in self.symbols:
            allocated_capital = base_capital_per_symbol
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç —ç–∫—Å–ø–æ–∑–∏—Ü–∏–∏
            exposure_limit = self.config.get(self.bot_type, {}).get('exposure_limit', 1.0)
            max_allowed_for_symbol = self.total_capital * exposure_limit
            if allocated_capital > max_allowed_for_symbol:
                allocated_capital = max_allowed_for_symbol
                self.logger.info(f"‚ö†Ô∏è {symbol}: –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —ç–∫—Å–ø–æ–∑–∏—Ü–∏–∏, —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ –¥–æ ${allocated_capital:.2f}")
                
            self.allocated_capital[symbol] = allocated_capital
            total_allocated += allocated_capital
            self.logger.info(f"üí∞ {symbol}: –≤—ã–¥–µ–ª–µ–Ω–æ ${allocated_capital:.2f}")
            
        # –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª
        self.reserve_capital = self.total_capital - total_allocated
        max_allowed_reserve = self.total_capital * 0.5
        if self.reserve_capital > max_allowed_reserve:
            self.reserve_capital = max_allowed_reserve
        self.logger.info(f"üí∞ –û–±–Ω–æ–≤–ª–µ–Ω —Ä–µ–∑–µ—Ä–≤: ${self.reserve_capital:.2f} (–º–∞–∫—Å. {max_allowed_reserve:.2f})")
        self.logger.info(f"‚úÖ –ü–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–∞ –¥–ª—è {self.bot_type} –∑–∞–≤–µ—Ä—à–µ–Ω–æ.")

    async def run(self):
        """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞"""
        try:
            await self.ex.load_markets()
            await self.update_capital()
            
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ø–∏—Ç–∞–ª–∞
            self.working_capital = self.total_capital * 0.5
            self.reserve_capital = self.total_capital * 0.5
            self.logger.info(f"üí∞ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ø–∏—Ç–∞–ª–∞: –í—Å–µ–≥–æ=${self.total_capital:.2f}, –†–∞–±–æ—á–∏–π=${self.working_capital:.2f}, –†–µ–∑–µ—Ä–≤=${self.reserve_capital:.2f}")
            
            # –ù–∞—á–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–∞
            await self.distribute_capital()
            
            # - –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1: –ó–∞–ø—É—Å–∫ —Ü–∏–∫–ª–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ -
            asyncio.create_task(self._daily_report_loop())
            # - /–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1 -
            
            self.logger.info(f"üü¢ {self.bot_type.capitalize()} Bot –∑–∞–ø—É—â–µ–Ω. –ù–∞—á–∞–ª—å–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª: {self.total_capital:.2f} USDT")
            await self.send(f"üü¢ {self.bot_type.capitalize()} Bot –∑–∞–ø—É—â–µ–Ω. –ö–∞–ø–∏—Ç–∞–ª: {self.total_capital:.2f} USDT")
            
            # –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
            while self.running:
                try:
                    await self.update_capital()
                    
                    # –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–∞
                    current_time = time.time()
                    if current_time - self.last_redistribution > self.redistribution_interval:
                        await self.distribute_capital()
                        self.last_redistribution = current_time
                        
                    # - –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2: –°–Ω–∞–ø—à–æ—Ç –ø–æ—Ä—Ç—Ñ–µ–ª—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç -
                    if int(time.time()) % 300 == 0:
                        await self._log_portfolio_snapshot()
                    # - /–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2 -
                    
                    # –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ –±–æ—Ç–∞
                    await self.execute_strategy()
                    
                    # –ü–∞—É–∑–∞
                    sleep_interval = self.config[self.bot_type]['sleep_interval']
                    await asyncio.sleep(sleep_interval)
                    
                except ccxt.NetworkError as e:
                    self.logger.error(f"–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: {e}")
                    await asyncio.sleep(10)
                except ccxt.ExchangeError as e:
                    self.logger.error(f"–ë–∏—Ä–∂–µ–≤–∞—è –æ—à–∏–±–∫–∞: {e}")
                    await asyncio.sleep(sleep_interval * 2)
                except Exception as e:
                    self.logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ü–∏–∫–ª–µ {self.bot_type}: {e}")
                    await asyncio.sleep(sleep_interval * 3)
                    
        except Exception as e:
            self.logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        finally:
            await self._shutdown()

    async def execute_strategy(self):
        """
        –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏. –î–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ –¥–æ—á–µ—Ä–Ω–∏—Ö –∫–ª–∞—Å—Å–∞—Ö.
        """
        raise NotImplementedError("–ú–µ—Ç–æ–¥ 'execute_strategy' –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ –¥–æ—á–µ—Ä–Ω–µ–º –∫–ª–∞—Å—Å–µ")

    # v2.0: –î–æ–±–∞–≤–ª–µ–Ω –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –º–µ—Ç–æ–¥ close_all_positions
    async def close_all_positions(self):
        """
        –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π.
        v2.0: –î–æ–±–∞–≤–ª–µ–Ω –∫–∞–∫ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –º–µ—Ç–æ–¥.
        """
        raise NotImplementedError("–ú–µ—Ç–æ–¥ 'close_all_positions' –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ –¥–æ—á–µ—Ä–Ω–µ–º –∫–ª–∞—Å—Å–µ")

    async def _shutdown(self):
        """
        Graceful shutdown –¥–ª—è –±–∞–∑–æ–≤–æ–≥–æ –±–æ—Ç–∞.
        v2.0: –î–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ close_all_positions.
        """
        self.logger.info(f"üõë {self.bot_type.capitalize()} graceful shutdown...")
        try:
            await self.close_all_positions()
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–π –≤–æ –≤—Ä–µ–º—è shutdown: {e}")
        self.running = False

    def exit_gracefully(self, signum, frame):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è graceful shutdown"""
        self.logger.info(f"üõë {self.bot_type.capitalize()} graceful shutdown (—Å–∏–≥–Ω–∞–ª {signum})")
        self.running = False


# v2.0 (+–ø—Ä–∞–≤–∫–∏ –∏–∑ –∞–Ω–∞–ª–∏–∑–∞: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–¥–µ–ª–æ–∫, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫, –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π, capital_distributor)
"""
Multi-Asset Scalping Trading Bot.
v2.0: –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–¥–µ–ª–æ–∫, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏, –¥–æ–±–∞–≤–ª–µ–Ω–æ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è capital_distributor.
"""
import ccxt.async_support as ccxt
import numpy as np
import talib
import asyncio
import time
import logging
import signal
import sys
import os
import json
import math
import collections
from datetime import datetime, timedelta
from telegram import Bot
from dotenv import load_dotenv
# - –î–û–ë–ê–í–õ–ï–ù–ò–ï 1: –ò–º–ø–æ—Ä—Ç log_helper -
from log_helper import build_logger
# - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 1 -
# - –î–û–ë–ê–í–õ–ï–ù–ò–ï 2: –ò–º–ø–æ—Ä—Ç ConfigManager -
from config_manager import ConfigManager
# - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 2 -
# - –î–û–ë–ê–í–õ–ï–ù–ò–ï 3: –ò–º–ø–æ—Ä—Ç IPC —Å–µ—Ä–≤–µ—Ä–∞ -
from ipc import ScalpBotIPCServer
# - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 3 -
# - –î–û–ë–ê–í–õ–ï–ù–ò–ï 4: –ò–º–ø–æ—Ä—Ç dataclasses –¥–ª—è TradeEvent -
from dataclasses import dataclass
# - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 4 -
# v2.0: –ò–º–ø–æ—Ä—Ç –Ω–æ–≤–æ–≥–æ –º–æ–¥—É–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞–ø–∏—Ç–∞–ª–∞
from capital_distributor import CapitalDistributor

load_dotenv()
os.makedirs('logs', exist_ok=True)

# === v2.0: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∏–∑ —á–µ–∫-–ª–∏—Å—Ç–∞ ===
# - –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–¥–µ–ª–æ–∫
# - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç—Ä–µ–Ω–¥–∞, —Å–ø—Ä–µ–¥–∞ –∏ —Ä—ã–Ω–∫–∞ (–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 18)
# - –î–æ–±–∞–≤–ª–µ–Ω graceful shutdown —Å –∑–∞–∫—Ä—ã—Ç–∏–µ–º –ø–æ–∑–∏—Ü–∏–π
# - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CapitalDistributor –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞–ø–∏—Ç–∞–ª–∞
# === /v2.0 ===

# - –î–û–ë–ê–í–õ–ï–ù–ò–ï 4: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ TradeEvent -
@dataclass
class TradeEvent:
    ts: float
    symbol: str
    side: str  # buy/sell
    price: float
    qty: float
    pnl: float = 0.0
# - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 4 -

class MultiAssetScalpBot:
    """
    Multi-Asset Scalping Trading Bot.
    v2.0: –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–¥–µ–ª–æ–∫, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏, –¥–æ–±–∞–≤–ª–µ–Ω–æ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è capital_distributor.
    """

    def __init__(self):
        # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 1: –ò—Å–ø–æ–ª—å–∑—É–µ–º log_helper –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ª–æ–≥-—Ñ–∞–π–ª–∞ -
        self.logger = build_logger("scalp_bot")
        # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 1 -
        
        # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 2: –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ ConfigManager -
        self.config_manager = ConfigManager()
        self.config = self.config_manager.get_config()
        # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 2 -
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∏—Ä–∂–∏
        API_KEY = os.getenv('API_KEY')
        API_SECRET = os.getenv('API_SECRET')
        PASSPHRASE = os.getenv('PASSPHRASE')
        if not all([API_KEY, API_SECRET, PASSPHRASE]):
            raise ValueError("‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è: API_KEY, API_SECRET, PASSPHRASE")
            
        self.ex = ccxt.okx({
            'apiKey': API_KEY,
            'secret': API_SECRET,
            'password': PASSPHRASE,
            'sandbox': True,  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ-—Ä–µ–∂–∏–º
            'enableRateLimit': True,
            'options': {'defaultType': 'spot'}
        })
        
        self.symbols = self.config['symbols']
        self.chat_ids = self.config['chat_ids']
        self.tg_bot = Bot(token=os.getenv('TELEGRAM_BOT_TOKEN'))
        self.running = True
        self.last_notification = 0
        
        # –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–∞
        self.total_capital = 0
        self.working_capital = 0
        self.reserve_capital = 0
        self.allocated_capital = {}  # {symbol: float}
        self.last_redistribution = 0
        self.redistribution_interval = self.config.get('redistribution_interval', 1800)  # 30 –º–∏–Ω—É—Ç
        
        # –°–æ—Å—Ç–æ—è–Ω–∏–µ Scalp-–±–æ—Ç–∞
        self.positions = {}  # {symbol: {'side': 'long'/'short', 'amount': float, 'entry': float, 'timestamp': float}}
        self.last_signal_times = {}
        self.consecutive_losses = {}
        
        # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 10: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ -
        cfg = self.config['scalp']['indicators']
        self.rsi_period = cfg['rsi']['timeperiod']
        self.stoch_fk = cfg['stoch']['fastk_period']
        self.stoch_sk = cfg['stoch']['slowk_period']
        self.stoch_smatype = cfg['stoch']['slowk_matype']
        self.stoch_sd = cfg['stoch']['slowd_period']
        self.stoch_smatype = cfg['stoch']['slowd_matype']
        self.macd_f = cfg['macd']['fastperiod']
        self.macd_s = cfg['macd']['slowperiod']
        self.macd_sig = cfg['macd']['signalperiod']
        self.ema_short = cfg['ema']['short_period']
        self.ema_long = cfg['ema']['long_period']
        self.atr_period = cfg['atr']['timeperiod']
        # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 10 -
        
        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–∏–≥–Ω–∞–ª–æ–≤
        signal.signal(signal.SIGINT, self.exit_gracefully)
        signal.signal(signal.SIGTERM, self.exit_gracefully)
        
        # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 3: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è IPC —Å–µ—Ä–≤–µ—Ä–∞ -
        self.ipc_server = ScalpBotIPCServer(self) if self.config.get('ipc_enabled', True) else None
        # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 3 -
        
        # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 5: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã TP/SL –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ -
        self.tp_pct = self.config['scalp'].get('tp_pct', 0.15) / 100
        self.sl_pct = self.config['scalp'].get('sl_pct', 0.25) / 100
        self.fee_rate = self.config['scalp'].get('fee_rate', 0.001)
        self.max_hold_seconds = self.config['scalp'].get('max_hold_seconds', 180)
        # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 5 -

    async def send(self, msg):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram"""
        now = time.time()
        if now - self.last_notification < 2:
            await asyncio.sleep(2 - (now - self.last_notification))
        self.last_notification = now
        for cid in self.chat_ids:
            try:
                await self.tg_bot.send_message(chat_id=cid, text=msg)
            except Exception as e:
                self.logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram: {e}")

    # - –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –º–µ—Ç–æ–¥ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–≤ -
    async def get_balances(self):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–≤ –¥–ª—è –≤—Å–µ—Ö —Å–∏–º–≤–æ–ª–æ–≤"""
        try:
            # - –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1: –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å –û–î–ò–ù –†–ê–ó -
            bal = await self.ex.fetch_balance({'type': 'spot'})
            # - /–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1 -
            balances = {}
            for symbol in self.symbols:
                base_currency = symbol.split('/')[0]
                quote_currency = symbol.split('/')[1]
                base_free = bal['free'].get(base_currency, 0)
                base_total = bal['total'].get(base_currency, 0)
                quote_free = bal['free'].get(quote_currency, 0)
                quote_total = bal['total'].get(quote_currency, 0)
                balances[symbol] = {
                    'base': base_total,
                    'quote': quote_total,
                    'free_base': base_free,
                    'free_quote': quote_free
                }
            return balances
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–≤: {e}")
            return {}
    # - /–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï -

    async def update_capital(self):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–∞–ø–∏—Ç–∞–ª–µ"""
        try:
            balances = await self.get_balances()
            self.total_capital = 0
            for symbol in self.symbols:
                symbol_balance = balances.get(symbol, {'base': 0, 'quote': 0})
                try:
                    ticker = await self.ex.fetch_ticker(symbol)
                    price = ticker['last']
                    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —ç–∫–≤–∏—Ç–∏ –¥–ª—è —Å–∏–º–≤–æ–ª–∞
                    base_equity = symbol_balance['base'] * price
                    quote_equity = symbol_balance['quote']
                    equity = base_equity + quote_equity
                    self.total_capital += equity
                    # - –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -
                    self.logger.debug(f"üí∞ {symbol}: {symbol_balance['base']:.6f} {symbol.split('/')[0]} + {symbol_balance['quote']:.2f} {symbol.split('/')[1]} ‚âà {equity:.2f} USDT")
                    # - /–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2 -
                except Exception as e:
                    self.logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ü–µ–Ω—É –¥–ª—è {symbol} –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–∞–ø–∏—Ç–∞–ª–∞: {e}")
            
            self.logger.info(f"üí∞ –û–±–Ω–æ–≤–ª–µ–Ω –∫–∞–ø–∏—Ç–∞–ª: –í—Å–µ–≥–æ=${self.total_capital:.2f} USDT")
        except Exception as e:
            self.logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–ø–∏—Ç–∞–ª–∞: {e}")
    # - /–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï -

    # - –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1: –ó–∞—â–∏—Ç–∞ –º–µ—Ç–æ–¥–∞ check_min_lot –æ—Ç NoneType -
    async def check_min_lot(self, symbol, amount, price):
        """
        –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –±–∏—Ä–∂–∏ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç None.
        """
        try:
            # 1. –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä—ã–Ω–∫–µ
            market_info = self.ex.market(symbol)
            
            # === v2.0: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1 - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç None ===
            if not market_info:
                self.logger.warning(f"‚ö†Ô∏è {symbol}: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä—ã–Ω–∫–µ")
                return False
            # === /v2.0: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1 ===
            
            # 2. –ü–æ–ª—É—á–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ä—ã–Ω–∫–∞
            min_amount = market_info.get('limits', {}).get('amount', {}).get('min', 0)
            min_cost = market_info.get('limits', {}).get('cost', {}).get('min', 0)
            
            # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–º
            if amount < min_amount:
                self.logger.info(f"‚ö†Ô∏è {symbol}: –û–±—ä–µ–º {amount} < –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ {min_amount}")
                return False
                
            # 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
            cost = amount * price
            if cost < min_cost:
                self.logger.info(f"‚ö†Ô∏è {symbol}: –°—Ç–æ–∏–º–æ—Å—Ç—å {cost:.4f} < –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π {min_cost}")
                return False
                
            return True
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –ª–æ—Ç–∞ –¥–ª—è {symbol}: {e}")
            return False # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Å—á–∏—Ç–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–π
    # - /–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1 -

    # v2.0: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 18 - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–π
    async def trend_filter(self, symbol):
        """–§–∏–ª—å—Ç—Ä —Ç—Ä–µ–Ω–¥–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ EMA200. v2.0: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 18."""
        try:
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ 1h
            ohlcv_1h = await self.ex.fetch_ohlcv(symbol, '1h', limit=210)
            if len(ohlcv_1h) < 200:
                self.logger.warning(f"‚ö†Ô∏è {symbol}: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç—Ä–µ–Ω–¥-—Ñ–∏–ª—å—Ç—Ä–∞ (1h)")
                return True  # –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –º–∞–ª–æ, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º

            closes_1h = np.array([candle[4] for candle in ohlcv_1h])

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ NaN
            if np.any(np.isnan(closes_1h)):
                self.logger.warning(f"‚ö†Ô∏è {symbol}: NaN –≤ –¥–∞–Ω–Ω—ã—Ö OHLCV –¥–ª—è —Ç—Ä–µ–Ω–¥-—Ñ–∏–ª—å—Ç—Ä–∞")
                return True  # –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω—ã, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º

            ema_200 = talib.EMA(closes_1h, timeperiod=200)
            if len(ema_200) == 0 or np.isnan(ema_200[-1]):
                return True  # –ï—Å–ª–∏ EMA –Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–ª–∞—Å—å, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º

            current_price = closes_1h[-1]
            # –¢—Ä–µ–Ω–¥ –≤–æ—Å—Ö–æ–¥—è—â–∏–π, –µ—Å–ª–∏ —Ü–µ–Ω–∞ –≤—ã—à–µ EMA200
            is_favorable = current_price > ema_200[-1]

            if not is_favorable:
                self.logger.info(f"‚ö†Ô∏è {symbol}: –ù–∏—Å—Ö–æ–¥—è—â–∏–π —Ç—Ä–µ–Ω–¥ (–¶–µ–Ω–∞ {current_price:.2f} < EMA200 {ema_200[-1]:.2f})")

            return is_favorable

        # === v2.0: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 18 - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–π ===
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ —Ç—Ä–µ–Ω–¥-—Ñ–∏–ª—å—Ç—Ä–∞ –¥–ª—è {symbol}: {e}")
            return True  # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º
        # === /v2.0: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 18 ===

    # v2.0: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 18 - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–π
    async def is_spread_acceptable(self, symbol):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ø—Ä–µ–¥–∞. v2.0: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 18."""
        try:
            ticker = await self.ex.fetch_ticker(symbol)
            bid = ticker['bid']
            ask = ticker['ask']

            if bid is None or ask is None or bid <= 0 or ask <= 0:
                return False

            spread_pct = (ask - bid) / bid
            # –°–ø—Ä–µ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–µ–Ω—å—à–µ 0.1% (0.001)
            return spread_pct < 0.001
        # === v2.0: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 18 - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–π ===
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–ø—Ä–µ–¥–∞ –¥–ª—è {symbol}: {e}")
            return False  # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Å—á–∏—Ç–∞–µ–º —Å–ø—Ä–µ–¥ –Ω–µ–ø—Ä–∏–µ–º–ª–µ–º—ã–º
        # === /v2.0: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 18 ===

    # v2.0: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 18 - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–π
    async def analyze_market_regime(self, symbol):
        """–ê–Ω–∞–ª–∏–∑ —Ä—ã–Ω–æ—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ —Å–∫–∞–ª—å–ø–∏–Ω–≥–∞. v2.0: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 18."""
        try:
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å —Ä–∞–∑–Ω—ã—Ö —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤
            ohlcv_5m = await self.ex.fetch_ohlcv(symbol, '5m', limit=50)
            ohlcv_15m = await self.ex.fetch_ohlcv(symbol, '15m', limit=50)

            if len(ohlcv_5m) < 20 or len(ohlcv_15m) < 20:
                return 0, {}

            closes_5m = np.array([x[4] for x in ohlcv_5m])
            highs_5m = np.array([x[2] for x in ohlcv_5m])
            lows_5m = np.array([x[3] for x in ohlcv_5m])
            volumes_5m = np.array([x[5] for x in ohlcv_5m])

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ NaN
            if np.any(np.isnan(closes_5m)) or np.any(np.isnan(highs_5m)) or np.any(np.isnan(lows_5m)):
                self.logger.warning(f"‚ö†Ô∏è {symbol}: NaN –≤ –¥–∞–Ω–Ω—ã—Ö OHLCV –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ä—ã–Ω–∫–∞")
                return 0, {}

            # RSI
            # - –î–û–ë–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ -
            rsi = talib.RSI(closes_5m, timeperiod=self.rsi_period)
            # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï -
            rsi_value = rsi[-1] if len(rsi) > 0 and not np.isnan(rsi[-1]) else 50

            # Stochastic
            # - –î–û–ë–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ -
            stoch_k, stoch_d = talib.STOCH(highs_5m, lows_5m, closes_5m,
                                          fastk_period=self.stoch_fk,
                                          slowk_period=self.stoch_sk,
                                          slowk_matype=self.stoch_smatype,
                                          slowd_period=self.stoch_sd,
                                          slowd_matype=self.stoch_smatype)
            # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï -
            stoch_k_val = stoch_k[-1] if len(stoch_k) > 0 and not np.isnan(stoch_k[-1]) else 50
            stoch_d_val = stoch_d[-1] if len(stoch_d) > 0 and not np.isnan(stoch_d[-1]) else 50

            # MACD
            # - –î–û–ë–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ -
            macd, macdsignal, macdhist = talib.MACD(closes_5m,
                                                   fastperiod=self.macd_f,
                                                   slowperiod=self.macd_s,
                                                   signalperiod=self.macd_sig)
            # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï -
            macd_value = macdhist[-1] if len(macdhist) > 0 and not np.isnan(macdhist[-1]) else 0

            # –û–±—ä–µ–º (OBV delta)
            obv = talib.OBV(closes_5m, volumes_5m)
            if len(obv) >= 2:
                obv_delta = obv[-1] - obv[-2]
                # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º OBV delta
                avg_volume = np.mean(volumes_5m[-20:]) if len(volumes_5m) >= 20 else 1
                obv_delta_norm = obv_delta / avg_volume if avg_volume > 0 else 0
            else:
                obv_delta_norm = 0

            # –í–∑–≤–µ—à–∏–≤–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã
            rsi_signal = 0
            if rsi_value < 30:
                rsi_signal = 1
            elif rsi_value > 70:
                rsi_signal = -1

            stoch_signal = 0
            if stoch_k_val < 20 and stoch_d_val < 20:
                stoch_signal = 1
            elif stoch_k_val > 80 and stoch_d_val > 80:
                stoch_signal = -1

            macd_signal = 0
            if macd_value > 0:
                macd_signal = 1
            elif macd_value < 0:
                macd_signal = -1

            obv_signal = 0
            if obv_delta_norm > 0.1:
                obv_signal = 1
            elif obv_delta_norm < -0.1:
                obv_signal = -1

            # –§–∏–Ω–∞–ª—å–Ω—ã–π —Å–∏–≥–Ω–∞–ª
            total_signal = (rsi_signal * 0.25 + stoch_signal * 0.25 + macd_signal * 0.25 + obv_signal * 0.25) * 100

            indicators = {
                'rsi': rsi_value,
                'stoch_k': stoch_k_val,
                'stoch_d': stoch_d_val,
                'macd_hist': macd_value,
                'obv_delta_norm': obv_delta_norm
            }

            return total_signal, indicators

        # === v2.0: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 18 - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–π ===
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ä—ã–Ω–∫–∞ –¥–ª—è {symbol}: {e}")
            return 0, {}  # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —Å–∏–≥–Ω–∞–ª
        # === /v2.0: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 18 ===

    async def combo_strategy(self, symbol):
        """–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è"""
        try:
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            ohlcv_5m = await self.ex.fetch_ohlcv(symbol, '5m', limit=50)
            ohlcv_15m = await self.ex.fetch_ohlcv(symbol, '15m', limit=50)
            
            if len(ohlcv_5m) < 20 or len(ohlcv_15m) < 20:
                return 0
                
            closes_5m = np.array([x[4] for x in ohlcv_5m])
            highs_5m = np.array([x[2] for x in ohlcv_5m])
            lows_5m = np.array([x[3] for x in ohlcv_5m])
            volumes_5m = np.array([x[5] for x in ohlcv_5m])
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ NaN
            if np.any(np.isnan(closes_5m)) or np.any(np.isnan(highs_5m)) or np.any(np.isnan(lows_5m)):
                self.logger.warning(f"NaN –≤ –¥–∞–Ω–Ω—ã—Ö OHLCV –¥–ª—è {symbol} –≤ combo_strategy")
                return 0
                
            # RSI (5m)
            # - –î–û–ë–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ -
            rsi_5m = talib.RSI(closes_5m, timeperiod=self.rsi_period)
            # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï -
            rsi_val_5m = rsi_5m[-1] if len(rsi_5m) > 0 and not np.isnan(rsi_5m[-1]) else 50
            
            # Stochastic (5m)
            # - –î–û–ë–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ -
            stoch_k_5m, stoch_d_5m = talib.STOCH(highs_5m, lows_5m, closes_5m,
                                                fastk_period=self.stoch_fk,
                                                slowk_period=self.stoch_sk,
                                                slowk_matype=self.stoch_smatype,
                                                slowd_period=self.stoch_sd,
                                                slowd_matype=self.stoch_smatype)
            # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï -
            stoch_k_val_5m = stoch_k_5m[-1] if len(stoch_k_5m) > 0 and not np.isnan(stoch_k_5m[-1]) else 50
            stoch_d_val_5m = stoch_d_5m[-1] if len(stoch_d_5m) > 0 and not np.isnan(stoch_d_5m[-1]) else 50
            
            # MACD (5m)
            # - –î–û–ë–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ -
            macd_5m, macdsignal_5m, macdhist_5m = talib.MACD(closes_5m,
                                                            fastperiod=self.macd_f,
                                                            slowperiod=self.macd_s,
                                                            signalperiod=self.macd_sig)
            # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï -
            macd_val_5m = macdhist_5m[-1] if len(macdhist_5m) > 0 and not np.isnan(macdhist_5m[-1]) else 0
            
            # EMA (15m)
            closes_15m = np.array([x[4] for x in ohlcv_15m])
            if np.any(np.isnan(closes_15m)):
                self.logger.warning(f"NaN –≤ –¥–∞–Ω–Ω—ã—Ö OHLCV 15m –¥–ª—è {symbol} –≤ combo_strategy")
                return 0
            # - –î–û–ë–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ -
            ema_9_15m = talib.EMA(closes_15m, timeperiod=self.ema_short)
            ema_21_15m = talib.EMA(closes_15m, timeperiod=self.ema_long)
            # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï -
            ema_9_val_15m = ema_9_15m[-1] if len(ema_9_15m) > 0 and not np.isnan(ema_9_15m[-1]) else 0
            ema_21_val_15m = ema_21_15m[-1] if len(ema_21_15m) > 0 and not np.isnan(ema_21_15m[-1]) else 0
            
            # –û–±—ä–µ–º–Ω—ã–π –∏–º–ø—É–ª—å—Å
            if len(volumes_5m) >= 5:
                avg_vol = np.mean(volumes_5m[-5:-1]) if len(volumes_5m) > 1 else 1
                current_vol = volumes_5m[-1]
                volume_impulse = current_vol / avg_vol if avg_vol > 0 else 1
            else:
                volume_impulse = 1
                
            # –í–∑–≤–µ—à–∏–≤–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã
            rsi_signal = 0
            if rsi_val_5m < 30:
                rsi_signal = 1
            elif rsi_val_5m > 70:
                rsi_signal = -1
                
            stoch_signal = 0
            if stoch_k_val_5m < 20 and stoch_d_val_5m < 20:
                stoch_signal = 1
            elif stoch_k_val_5m > 80 and stoch_d_val_5m > 80:
                stoch_signal = -1
                
            macd_signal = 0
            if macd_val_5m > 0:
                macd_signal = 1
            elif macd_val_5m < 0:
                macd_signal = -1
                
            ema_signal = 0
            if ema_9_val_15m > ema_21_val_15m:
                ema_signal = 1
            elif ema_9_val_15m < ema_21_val_15m:
                ema_signal = -1
                
            volume_signal = 0
            if volume_impulse > 1.5:
                volume_signal = 0.5  # –£–º–µ—Ä–µ–Ω–Ω—ã–π –≤–µ—Å
                
            # –§–∏–Ω–∞–ª—å–Ω—ã–π —Å–∏–≥–Ω–∞–ª
            total_signal = (rsi_signal * 0.25 + stoch_signal * 0.25 + macd_signal * 0.25 + 
                          ema_signal * 0.15 + volume_signal * 0.1) * 100
                          
            return total_signal
            
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ combo —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–ª—è {symbol}: {e}")
            return 0

    async def open_position(self, symbol, signal_strength):
        """–û—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏"""
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∑–∏—Ü–∏–π
            if len(self.positions) >= self.config['scalp']['max_positions']:
                self.logger.info(f"‚ö†Ô∏è {symbol}: –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –ø–æ–∑–∏—Ü–∏–π ({self.config['scalp']['max_positions']})")
                return
                
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –ø–æ–∑–∏—Ü–∏—è –ø–æ —ç—Ç–æ–π –ø–∞—Ä–µ
            if symbol in self.positions:
                self.logger.info(f"‚ö†Ô∏è {symbol}: –ü–æ–∑–∏—Ü–∏—è —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–∞")
                return
                
            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É
            ticker = await self.ex.fetch_ticker(symbol)
            current_price = ticker['last']
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ª–æ—Ç
            if not await self.check_min_lot(symbol, 0.001, current_price):  # –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
                self.logger.warning(f"‚ö†Ô∏è {symbol}: –ù–µ –ø—Ä–æ—à—ë–ª –ø—Ä–æ–≤–µ—Ä–∫—É –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –ª–æ—Ç–∞")
                return
                
            # –ü–æ–ª—É—á–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª
            allocated_capital_for_symbol = self.allocated_capital.get(symbol, 0)
            if allocated_capital_for_symbol < self.config['scalp']['min_order_usd']:
                self.logger.info(f"‚ö†Ô∏è {symbol}: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª ({allocated_capital_for_symbol:.2f} USDT)")
                return
                
            # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏
            position_size_usd = allocated_capital_for_symbol * self.config['scalp']['position_size_percent']
            amount_asset = position_size_usd / current_price
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –ª–æ—Ç–∞
            if not await self.check_min_lot(symbol, amount_asset, current_price):
                return
                
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–æ—Ä–æ–Ω—É
            side = 'buy' if signal_strength > 0 else 'sell'
            
            # –°–æ–∑–¥–∞–µ–º –æ—Ä–¥–µ—Ä
            if side == 'buy':
                order = await self.ex.create_market_buy_order(symbol, amount_asset)
            else:
                order = await self.ex.create_market_sell_order(symbol, amount_asset)
                
            order_id = order['id']
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∑–∏—Ü–∏–∏
            self.positions[symbol] = {
                'side': 'long' if side == 'buy' else 'short',
                'amount': amount_asset,
                'entry': current_price,
                'timestamp': time.time()
            }
            
            self.logger.info(f"‚ö° {symbol}: –û—Ç–∫—Ä—ã—Ç–∞ –ø–æ–∑–∏—Ü–∏—è {side.upper()} {amount_asset:.6f} @ {current_price:.2f}")
            
            # === v2.0: –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏ ===
            trade_event = TradeEvent(
                ts=time.time(),
                symbol=symbol,
                side=side.upper(),
                price=current_price,
                qty=amount_asset
            )
            await self.log_trade(trade_event)
            # === /v2.0: –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏ ===
            
        except ccxt.InsufficientFunds as e:
            self.logger.warning(f"‚ö†Ô∏è {symbol}: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏: {e}")
        except Exception as e:
            self.logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è {symbol}: {e}")

    async def close_position(self, symbol, reason="TP/SL"):
        """–ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏"""
        if symbol not in self.positions:
            return
            
        try:
            pos = self.positions[symbol]
            
            # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
            balances = await self.get_balances()
            symbol_balance = balances.get(symbol, {'base': 0, 'quote': 0})
            base_asset = symbol.split('/')[0]
            current_amount = symbol_balance['base'] if base_asset else 0
            
            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É
            ticker = await self.ex.fetch_ticker(symbol)
            current_price = ticker['last']
            
            if pos['side'] == 'long' and current_amount > 0:
                self.logger.info(f"–ó–∞–∫—Ä—ã—Ç–∏–µ –¥–ª–∏–Ω–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏ {symbol}...")
                order = await self.ex.create_market_sell_order(symbol, current_amount)
                
                # === v2.0: –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏ ===
                pnl = (current_price - pos['entry']) * current_amount
                trade_event = TradeEvent(
                    ts=time.time(),
                    symbol=symbol,
                    side='SELL',
                    price=current_price,
                    qty=current_amount,
                    pnl=pnl
                )
                await self.log_trade(trade_event)
                # === /v2.0: –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏ ===
                
                self.logger.info(f"‚ö° {symbol}: –ó–∞–∫—Ä—ã—Ç–∞ –ø–æ–∑–∏—Ü–∏—è LONG {current_amount:.6f} @ {current_price:.2f} ({reason}) PnL: ${pnl:.2f}")
                
            elif pos['side'] == 'short':
                # –î–ª—è —à–æ—Ä—Ç–æ–≤ –≤ spot –Ω—É–∂–Ω–æ –∏–º–µ—Ç—å –±–∞–∑–æ–≤—ã–π –∞–∫—Ç–∏–≤, —á—Ç–æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ
                # –ü–æ—ç—Ç–æ–º—É –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –æ –ø–æ–∑–∏—Ü–∏–∏
                self.logger.info(f"‚ö° {symbol}: –ü–æ–∑–∏—Ü–∏—è SHORT –∑–∞–∫—Ä—ã—Ç–∞ (—É–¥–∞–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å) ({reason})")
                
            # –£–¥–∞–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –∏–∑ —Å–ª–æ–≤–∞—Ä—è
            del self.positions[symbol]
            
        except Exception as e:
            self.logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ {symbol}: {e}")

    async def check_positions(self):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∑–∏—Ü–∏–π –Ω–∞ TP/SL –∏ —Ç–∞–π–º–∞—É—Ç"""
        current_time = time.time()
        symbols_to_close = []
        
        for symbol, pos in self.positions.items():
            try:
                # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É
                ticker = await self.ex.fetch_ticker(symbol)
                current_price = ticker['last']
                
                # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º PnL
                if pos['side'] == 'long':
                    pnl_pct = (current_price - pos['entry']) / pos['entry'] * 100
                else:  # short
                    pnl_pct = (pos['entry'] - current_price) / pos['entry'] * 100
                    
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º TP/SL
                tp_pct = self.tp_pct * 100
                sl_pct = self.sl_pct * 100
                
                if pnl_pct >= tp_pct:
                    symbols_to_close.append((symbol, "TP"))
                elif pnl_pct <= -sl_pct:
                    symbols_to_close.append((symbol, "SL"))
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–π–º–∞—É—Ç
                elif current_time - pos['timestamp'] > self.max_hold_seconds:
                    symbols_to_close.append((symbol, "Timeout"))
                    
            except Exception as e:
                self.logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–∑–∏—Ü–∏–∏ {symbol}: {e}")
                
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏
        for symbol, reason in symbols_to_close:
            await self.close_position(symbol, reason)

    # v2.0: –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ –∑–∞–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π
    async def close_all_positions(self):
        """
        v2.0: –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ –∑–∞–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π.
        """
        self.logger.info("üö™ –ù–∞—á–∞–ª–æ –∑–∞–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π Scalp-–±–æ—Ç–∞...")
        
        symbols_to_close = list(self.positions.keys())
        for symbol in symbols_to_close:
            try:
                await self.close_position(symbol, "Shutdown")
            except Exception as e:
                self.logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ {symbol}: {e}")
                
        self.logger.info("‚úÖ –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π Scalp-–±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.")

    # v2.0: –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Ç–æ–¥–∞ graceful shutdown
    async def _shutdown(self):
        """
        v2.0: –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ graceful shutdown –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–π.
        """
        self.logger.info("üõë –ù–∞—á–∞–ª–æ graceful shutdown Scalp-–±–æ—Ç–∞...")
        await self.close_all_positions()
        # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ IPC —Å–µ—Ä–≤–µ—Ä–∞
        if self.ipc_server:
            await self.ipc_server.stop()
        self.running = False
        self.logger.info("üõë Graceful shutdown Scalp-–±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω.")

    # - –ú–µ—Ç–æ–¥ execute_strategy –¥–ª—è Scalp-–±–æ—Ç–∞ -
    async def execute_strategy(self):
        """–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ç–æ—Ä–≥–æ–≤–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–ª—è Scalp-–±–æ—Ç–∞"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–∑–∏—Ü–∏–∏
        await self.check_positions()
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤—ã
        for symbol in self.symbols:
            try:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç—Ä–µ–Ω–¥
                if not await self.trend_filter(symbol):
                    continue
                    
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ø—Ä–µ–¥
                if not await self.is_spread_acceptable(symbol):
                    self.logger.info(f"‚ö†Ô∏è {symbol}: –°–ø—Ä–µ–¥ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π")
                    continue
                    
                # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä—ã–Ω–æ–∫
                signal_strength, indicators = await self.analyze_market_regime(symbol)
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–ª—É —Å–∏–≥–Ω–∞–ª–∞
                threshold = self.config['scalp'].get('signal_threshold', 50)
                if abs(signal_strength) >= threshold:
                    self.logger.info(f"‚ö° {symbol}: –°–∏–≥–Ω–∞–ª {signal_strength:.1f} (–ø–æ—Ä–æ–≥ {threshold})")
                    await self.open_position(symbol, signal_strength)
                else:
                    self.logger.debug(f"üîç {symbol}: –°–∏–≥–Ω–∞–ª {signal_strength:.1f} < –ø–æ—Ä–æ–≥–∞ {threshold}")
                    
            except Exception as e:
                self.logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ {symbol}: {e}")
    # - /–ú–µ—Ç–æ–¥ execute_strategy –¥–ª—è Scalp-–±–æ—Ç–∞ -

    async def run(self):
        """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞"""
        try:
            await self.ex.load_markets()
            await self.update_capital()
            
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ø–∏—Ç–∞–ª–∞
            self.working_capital = self.total_capital * 0.5
            self.reserve_capital = self.total_capital * 0.5
            self.logger.info(f"üí∞ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ø–∏—Ç–∞–ª–∞: –í—Å–µ–≥–æ=${self.total_capital:.2f}, –†–∞–±–æ—á–∏–π=${self.working_capital:.2f}, –†–µ–∑–µ—Ä–≤=${self.reserve_capital:.2f}")
            
            # v2.0: –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Ç–æ–¥–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞–ø–∏—Ç–∞–ª–∞
            await self.distribute_capital()
            
            self.logger.info(f"üü¢ Scalp Bot –∑–∞–ø—É—â–µ–Ω. –ù–∞—á–∞–ª—å–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª: {self.total_capital:.2f} USDT")
            await self.send(f"üü¢ Scalp Bot –∑–∞–ø—É—â–µ–Ω. –ö–∞–ø–∏—Ç–∞–ª: {self.total_capital:.2f} USDT")
            
            # –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
            while self.running:
                try:
                    await self.update_capital()
                    
                    # –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–∞
                    current_time = time.time()
                    if current_time - self.last_redistribution > self.redistribution_interval:
                        await self.distribute_capital()
                        self.last_redistribution = current_time
                    
                    # –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ –±–æ—Ç–∞
                    await self.execute_strategy()
                    
                    # –ü–∞—É–∑–∞
                    sleep_interval = self.config['scalp']['sleep_interval']
                    await asyncio.sleep(sleep_interval)
                    
                except ccxt.NetworkError as e:
                    self.logger.error(f"–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: {e}")
                    await asyncio.sleep(10)
                except ccxt.ExchangeError as e:
                    self.logger.error(f"–ë–∏—Ä–∂–µ–≤–∞—è –æ—à–∏–±–∫–∞: {e}")
                    await asyncio.sleep(sleep_interval * 2)
                except Exception as e:
                    self.logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ü–∏–∫–ª–µ Scalp: {e}")
                    await asyncio.sleep(sleep_interval * 3)
                    
        except Exception as e:
            self.logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        finally:
            await self._shutdown()

    def exit_gracefully(self, signum, frame):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è graceful shutdown"""
        self.logger.info(f"üõë Scalp graceful shutdown (—Å–∏–≥–Ω–∞–ª {signum})")
        self.running = False

    # v2.0: –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Ç–æ–¥–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞–ø–∏—Ç–∞–ª–∞
    async def distribute_capital(self):
        """
        –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–æ–¥ –∏–∑ –±–∞–∑–æ–≤–æ–≥–æ –∫–ª–∞—Å—Å–∞ –¥–ª—è Scalp-–±–æ—Ç–∞.
        v2.0: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç CapitalDistributor –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è.
        """
        self.logger.info("üîÑ –ù–∞—á–∞–ª–æ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞–ø–∏—Ç–∞–ª–∞ –¥–ª—è Scalp...")
        
        # v2.0: –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π –º–æ–¥—É–ª—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞–ø–∏—Ç–∞–ª–∞
        distributor = CapitalDistributor(self.ex)
        allocations = await distributor.distribute_for_strategy('scalp', self.symbols)
        
        self.allocated_capital = allocations
        
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
        for symbol, amount in self.allocated_capital.items():
            self.logger.info(f"üí∞ {symbol}: –≤—ã–¥–µ–ª–µ–Ω–æ ${amount:.2f} USDT")
            
        self.logger.info("‚úÖ –ü–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–∞ –¥–ª—è Scalp –∑–∞–≤–µ—Ä—à–µ–Ω–æ.")

    # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 1: –ú–µ—Ç–æ–¥ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–¥–µ–ª–æ–∫ -
    async def log_trade(self, event: TradeEvent):
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏"""
        msg = (f"{event.symbol} <b>{'–û–¢–ö–†–´–¢–ò–ï' if event.pnl == 0 else '–ó–ê–ö–†–´–¢–ò–ï'}</b>\n"
               f"üí∞ –¶–µ–Ω–∞: <code>{event.price:.4f}</code>\n"
               f"üì¶ –û–±—ä—ë–º: <code>{event.qty:.4f}</code>")
        if event.pnl != 0:
            msg += f"\nüìä PnL: <code>{event.pnl:.2f}</code> $"
        self.logger.info(msg.replace('<b>', '').replace('</code>', ''))
        await self.send(msg)
    # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 1 -

# - –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ -
async def main():
    bot = MultiAssetScalpBot()
    
    # –ó–∞–ø—É—Å–∫ IPC —Å–µ—Ä–≤–µ—Ä–∞
    if bot.ipc_server:
        await bot.ipc_server.start()
        
    await bot.run()

if __name__ == "__main__":
    if not os.path.exists('.env'):
        print("‚ùå –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        print("–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env —Å –≤–∞—à–∏–º–∏ API –∫–ª—é—á–∞–º–∏")
        sys.exit(1)
        
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("üõë –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        logging.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
# - /–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ -


# v2.0 (+–ø—Ä–∞–≤–∫–∏ –∏–∑ –∞–Ω–∞–ª–∏–∑–∞: futures —Ä–µ–∂–∏–º, spot sell, CCI –ø–æ—Ä–æ–≥, cooldown, –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
"""
Multi-Asset Grid Trading Bot.
v2.0: –î–æ–±–∞–≤–ª–µ–Ω —Ä–µ–∂–∏–º futures, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã Sell-—É—Ä–æ–≤–Ω–∏, –¥–æ–±–∞–≤–ª–µ–Ω—ã cooldown –∏ CCI-–ø–æ—Ä–æ–≥, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π.
"""
import ccxt.async_support as ccxt
import numpy as np
import talib
import asyncio
import time
import logging
import signal
import sys
import os
import json
import math
import collections
from datetime import datetime, timedelta
from telegram import Bot
from dotenv import load_dotenv
# - –î–û–ë–ê–í–õ–ï–ù–ò–ï 1: –ò–º–ø–æ—Ä—Ç log_helper -
from log_helper import build_logger
# - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 1 -
# - –î–û–ë–ê–í–õ–ï–ù–ò–ï 2: –ò–º–ø–æ—Ä—Ç ConfigManager -
from config_manager import ConfigManager
# - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 2 -
# - –î–û–ë–ê–í–õ–ï–ù–ò–ï 3: –ò–º–ø–æ—Ä—Ç IPC —Å–µ—Ä–≤–µ—Ä–∞ -
from ipc import GridBotIPCServer
# - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 3 -
# - –î–û–ë–ê–í–õ–ï–ù–ò–ï 4: –ò–º–ø–æ—Ä—Ç dataclasses –¥–ª—è TradeEvent -
from dataclasses import dataclass, field
# - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 4 -
# v2.0: –ò–º–ø–æ—Ä—Ç –Ω–æ–≤–æ–≥–æ –º–æ–¥—É–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞–ø–∏—Ç–∞–ª–∞
from capital_distributor import CapitalDistributor

load_dotenv()
os.makedirs('logs', exist_ok=True)

# === v2.0: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∏–∑ —á–µ–∫-–ª–∏—Å—Ç–∞ ===
# - –î–æ–±–∞–≤–ª–µ–Ω —Ä–µ–∂–∏–º futures
# - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω Sell-—É—Ä–æ–≤–Ω–∏ –¥–ª—è spot
# - –î–æ–±–∞–≤–ª–µ–Ω CCI –ø–æ—Ä–æ–≥ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
# - –î–æ–±–∞–≤–ª–µ–Ω cooldown
# - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä—ã–Ω–∫–∞
# - –î–æ–±–∞–≤–ª–µ–Ω graceful shutdown —Å –∑–∞–∫—Ä—ã—Ç–∏–µ–º –ø–æ–∑–∏—Ü–∏–π
# - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —É—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏ –≤ executed_order_ids
# === /v2.0 ===

logger = logging.getLogger(__name__)

# - –î–û–ë–ê–í–õ–ï–ù–ò–ï 4: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ TradeEvent -
@dataclass
class TradeEvent:
    ts: float
    symbol: str
    side: str  # buy/sell
    price: float
    qty: float
    pnl: float = 0.0
# - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 4 -

class MultiAssetGridBot:
    """
    Multi-Asset Grid Trading Bot.
    v2.0: –î–æ–±–∞–≤–ª–µ–Ω —Ä–µ–∂–∏–º futures, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã Sell-—É—Ä–æ–≤–Ω–∏, –¥–æ–±–∞–≤–ª–µ–Ω—ã cooldown –∏ CCI-–ø–æ—Ä–æ–≥, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π.
    """

    def __init__(self):
        # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 1: –ò—Å–ø–æ–ª—å–∑—É–µ–º log_helper –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ª–æ–≥-—Ñ–∞–π–ª–∞ -
        self.logger = build_logger("grid_bot")
        # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 1 -
        
        # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 2: –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ ConfigManager -
        self.config_manager = ConfigManager()
        self.config = self.config_manager.get_config()
        # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 2 -
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∏—Ä–∂–∏
        API_KEY = os.getenv('API_KEY')
        API_SECRET = os.getenv('API_SECRET')
        PASSPHRASE = os.getenv('PASSPHRASE')
        if not all([API_KEY, API_SECRET, PASSPHRASE]):
            raise ValueError("‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è: API_KEY, API_SECRET, PASSPHRASE")
            
        self.ex = ccxt.okx({
            'apiKey': API_KEY,
            'secret': API_SECRET,
            'password': PASSPHRASE,
            'sandbox': True,  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ-—Ä–µ–∂–∏–º
            'enableRateLimit': True,
            'options': {'defaultType': 'spot'}
        })
        
        self.symbols = self.config['symbols']
        self.chat_ids = self.config['chat_ids']
        self.tg_bot = Bot(token=os.getenv('TELEGRAM_BOT_TOKEN'))
        self.running = True
        self.last_notification = 0
        
        # –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–∞
        self.total_capital = 0
        self.working_capital = 0
        self.reserve_capital = 0
        self.allocated_capital = {}  # {symbol: float}
        self.last_redistribution = 0
        self.redistribution_interval = self.config.get('redistribution_interval', 1800)  # 30 –º–∏–Ω—É—Ç
        self.last_full_equity = 0
        self.equity_history = collections.deque(maxlen=200)
        
        # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 6: –ë—É—Ñ–µ—Ä –¥–ª—è —Å–¥–µ–ª–æ–∫ –∑–∞ 24 —á–∞—Å–∞ -
        self.trades_24h: list[TradeEvent] = []
        # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 6 -
        
        # –°–æ—Å—Ç–æ—è–Ω–∏–µ Grid-–±–æ—Ç–∞
        self.asset_grids = {}  # {symbol: {order_id: order_info}}
        # v2.0: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2 - –ò—Å–ø–æ–ª—å–∑—É–µ–º deque —Å maxlen –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏
        self.executed_order_ids = collections.deque(maxlen=1000)  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2
        # v2.0: –î–æ–±–∞–≤–ª–µ–Ω —Å–ª–æ–≤–∞—Ä—å –¥–ª—è cooldown
        self.last_grid_updates = {}
        
        # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 7: –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å—Ç–∞—Ä—Ç–µ -
        # asyncio.create_task(self._send_start_notification()) # –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ run()
        # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 7 -
        
        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–∏–≥–Ω–∞–ª–æ–≤
        signal.signal(signal.SIGINT, self.exit_gracefully)
        signal.signal(signal.SIGTERM, self.exit_gracefully)
        
        # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 3: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è IPC —Å–µ—Ä–≤–µ—Ä–∞ -
        self.ipc_server = GridBotIPCServer(self) if self.config.get('ipc_enabled', True) else None
        # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 3 -
        
        # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 5: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è TP –æ—Ä–¥–µ—Ä–æ–≤ -
        self.tp_multiplier = 1.0  # –ú–Ω–æ–∂–∏—Ç–µ–ª—å –¥–ª—è TP, –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º
        # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 5 -
        
        # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 10: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ -
        cfg = self.config['grid']['indicators']
        self.rsi_period = cfg['rsi']['timeperiod']
        self.stoch_fk = cfg['stoch']['fastk_period']
        self.stoch_sk = cfg['stoch']['slowk_period']
        self.stoch_smatype = cfg['stoch']['slowk_matype']
        self.stoch_sd = cfg['stoch']['slowd_period']
        self.stoch_smatype = cfg['stoch']['slowd_matype']
        self.macd_f = cfg['macd']['fastperiod']
        self.macd_s = cfg['macd']['slowperiod']
        self.macd_sig = cfg['macd']['signalperiod']
        self.ema_short = cfg['ema']['short_period']
        self.ema_long = cfg['ema']['long_period']
        self.atr_period = cfg['atr']['timeperiod']
        self.bb_period = cfg['bb']['timeperiod']
        self.bb_nbdevup = cfg['bb']['nbdevup']
        self.bb_nbdevdn = cfg['bb']['nbdevdn']
        # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 10 -
        
        # v2.0: –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
        self.cci_block = self.config['grid'].get('cci_block', -100)
        self.grid_mode = self.config['grid'].get('grid_mode', 'spot')

    # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 8: –ú–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏ HTML —Å–æ–æ–±—â–µ–Ω–∏–π -
    async def _send_html(self, text: str):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ HTML-—Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram"""
        now = time.time()
        if now - self.last_notification < 2:
            await asyncio.sleep(2 - (now - self.last_notification))
        self.last_notification = now
        for cid in self.chat_ids:
            try:
                await self.tg_bot.send_message(chat_id=cid, text=text, parse_mode='HTML')
            except Exception as e:
                self.logger.error(f"Telegram error: {e}")
    # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 8 -
    
    # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 9: –ú–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å—Ç–∞—Ä—Ç–µ -
    async def _send_start_notification(self):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞"""
        await asyncio.sleep(1)  # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        await self.update_capital()
        msg = (f"üöÄ <b>GRID BOT –°–¢–ê–†–¢</b>\n"
               f"üìä –ö–∞–ø–∏—Ç–∞–ª: <code>{self.total_capital:.2f}</code> USDT\n"
               f"üîß –ü–∞—Ä—ã: {', '.join(self.symbols)}")
        self.logger.info(msg.replace('<b>', '').replace('</b>', '').replace('<code>', '').replace('</code>', ''))
        await self._send_html(msg)
    # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 9 -
    
    async def send(self, msg):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram"""
        now = time.time()
        if now - self.last_notification < 2:
            await asyncio.sleep(2 - (now - self.last_notification))
        self.last_notification = now
        for cid in self.chat_ids:
            try:
                await self.tg_bot.send_message(chat_id=cid, text=msg)
            except Exception as e:
                self.logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram: {e}")

    # - –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –º–µ—Ç–æ–¥ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–≤ -
    async def get_balances(self):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–≤ –¥–ª—è –≤—Å–µ—Ö —Å–∏–º–≤–æ–ª–æ–≤"""
        try:
            # - –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1: –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å –û–î–ò–ù –†–ê–ó -
            bal = await self.ex.fetch_balance({'type': 'spot'})
            # - /–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1 -
            balances = {}
            for symbol in self.symbols:
                base_currency = symbol.split('/')[0]
                quote_currency = symbol.split('/')[1]
                base_free = bal['free'].get(base_currency, 0)
                base_total = bal['total'].get(base_currency, 0)
                quote_free = bal['free'].get(quote_currency, 0)
                quote_total = bal['total'].get(quote_currency, 0)
                balances[symbol] = {
                    'base': base_total,
                    'quote': quote_total,
                    'free_base': base_free,
                    'free_quote': quote_free
                }
            return balances
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–≤: {e}")
            return {}
    # - /–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï -

    async def update_capital(self):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–∞–ø–∏—Ç–∞–ª–µ"""
        try:
            balances = await self.get_balances()
            self.total_capital = 0
            for symbol in self.symbols:
                symbol_balance = balances.get(symbol, {'base': 0, 'quote': 0})
                try:
                    ticker = await self.ex.fetch_ticker(symbol)
                    price = ticker['last']
                    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —ç–∫–≤–∏—Ç–∏ –¥–ª—è —Å–∏–º–≤–æ–ª–∞
                    base_equity = symbol_balance['base'] * price
                    quote_equity = symbol_balance['quote']
                    equity = base_equity + quote_equity
                    self.total_capital += equity
                    # - –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -
                    self.logger.debug(f"üí∞ {symbol}: {symbol_balance['base']:.6f} {symbol.split('/')[0]} + {symbol_balance['quote']:.2f} {symbol.split('/')[1]} ‚âà {equity:.2f} USDT")
                    # - /–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2 -
                except Exception as e:
                    self.logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ü–µ–Ω—É –¥–ª—è {symbol} –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–∞–ø–∏—Ç–∞–ª–∞: {e}")
            
            self.last_full_equity = self.total_capital
            self.logger.info(f"üí∞ –û–±–Ω–æ–≤–ª–µ–Ω –∫–∞–ø–∏—Ç–∞–ª: –í—Å–µ–≥–æ=${self.total_capital:.2f} USDT")
        except Exception as e:
            self.logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–ø–∏—Ç–∞–ª–∞: {e}")
    # - /–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï -

    # - –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1: –ó–∞—â–∏—Ç–∞ –º–µ—Ç–æ–¥–∞ check_min_lot –æ—Ç NoneType -
    async def check_min_lot(self, symbol, amount, price):
        """
        –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –±–∏—Ä–∂–∏ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç None.
        """
        try:
            # 1. –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä—ã–Ω–∫–µ
            market_info = self.ex.market(symbol)
            
            # === v2.0: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1 - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç None ===
            if not market_info:
                self.logger.warning(f"‚ö†Ô∏è {symbol}: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä—ã–Ω–∫–µ")
                return False
            # === /v2.0: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1 ===
            
            # 2. –ü–æ–ª—É—á–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ä—ã–Ω–∫–∞
            min_amount = market_info.get('limits', {}).get('amount', {}).get('min', 0)
            min_cost = market_info.get('limits', {}).get('cost', {}).get('min', 0)
            
            # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–º
            if amount < min_amount:
                self.logger.info(f"‚ö†Ô∏è {symbol}: –û–±—ä–µ–º {amount} < –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ {min_amount}")
                return False
                
            # 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
            cost = amount * price
            if cost < min_cost:
                self.logger.info(f"‚ö†Ô∏è {symbol}: –°—Ç–æ–∏–º–æ—Å—Ç—å {cost:.4f} < –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π {min_cost}")
                return False
                
            return True
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –ª–æ—Ç–∞ –¥–ª—è {symbol}: {e}")
            return False # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Å—á–∏—Ç–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–π
    # - /–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1 -

    async def analyze_market_regime(self, symbol, ohlcv):
        """–ê–Ω–∞–ª–∏–∑ —Ä—ã–Ω–æ—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π —Å–µ—Ç–∫–∏"""
        try:
            if len(ohlcv) < 20:
                self.logger.warning(f"–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö OHLCV –¥–ª—è {symbol} –≤ analyze_market_regime")
                return 'neutral', 1.0, 0.01, 0.001, 0, 50, 0  # –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                
            closes = np.array([candle[4] for candle in ohlcv])
            highs = np.array([candle[2] for candle in ohlcv])
            lows = np.array([candle[3] for candle in ohlcv])
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ NaN
            if np.any(np.isnan(closes)) or np.any(np.isnan(highs)) or np.any(np.isnan(lows)):
                self.logger.warning(f"NaN –≤ –¥–∞–Ω–Ω—ã—Ö OHLCV –¥–ª—è {symbol} –≤ analyze_market_regime")
                return 'neutral', 1.0, 0.01, 0.001, 0, 50, 0
                
            # –†–∞—Å—á–µ—Ç –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ (ATR)
            # - –î–û–ë–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ -
            atr = talib.ATR(highs, lows, closes, timeperiod=self.atr_period)
            # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï -
            atr_value = atr[-1] if len(atr) > 0 and not np.isnan(atr[-1]) else 0.001 * closes[-1] if len(closes) > 0 else 0.001
            avg_price = np.mean(closes)
            volatility = (atr_value / avg_price) if avg_price > 0 else 0
            
            # –°–∏–ª–∞ —Ç—Ä–µ–Ω–¥–∞ (ADX)
            adx = talib.ADX(highs, lows, closes, timeperiod=14)
            adx_value = adx[-1] if len(adx) > 0 and not np.isnan(adx[-1]) else 20
            
            # RSI
            # - –î–û–ë–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ -
            rsi = talib.RSI(closes, timeperiod=self.rsi_period)
            # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï -
            rsi_value = rsi[-1] if len(rsi) > 0 and not np.isnan(rsi[-1]) else 50
            
            # Bollinger Bands Width
            # - –î–û–ë–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ -
            bb_upper, bb_middle, bb_lower = talib.BBANDS(closes, timeperiod=self.bb_period,
                                                        nbdevup=self.bb_nbdevup, nbdevdn=self.bb_nbdevdn)
            # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï -
            if len(bb_upper) > 0 and len(bb_lower) > 0 and len(bb_middle) > 0 and \
               not np.isnan(bb_upper[-1]) and not np.isnan(bb_lower[-1]) and not np.isnan(bb_middle[-1]) and \
               (bb_upper[-1] - bb_lower[-1]) > 0:
                bb_width = (bb_upper[-1] - bb_lower[-1]) / bb_middle[-1]
            else:
                bb_width = 0.02
                
            # CCI
            cci = talib.CCI(highs, lows, closes, timeperiod=14)
            cci_value = cci[-1] if len(cci) > 0 and not np.isnan(cci[-1]) else 0
            
            # –¢—Ä–µ–Ω–¥ –Ω–∞ 15m
            trend_strength = 0
            # if len(ohlcv_15m) >= 20:
            #     closes_15m = np.array([x[4] for x in ohlcv_15m])
            #     if not np.any(np.isnan(closes_15m)):
            #         # - –î–û–ë–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ -
            #         ema_9 = talib.EMA(closes_15m, timeperiod=self.ema_short)
            #         ema_21 = talib.EMA(closes_15m, timeperiod=self.ema_long)
            #         # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï -
            #         ema_9_val = ema_9[-1] if len(ema_9) > 0 and not np.isnan(ema_9[-1]) else 0
            #         ema_21_val = ema_21[-1] if len(ema_21) > 0 and not np.isnan(ema_21[-1]) else 0
            #         if ema_21_val > 0:
            #             trend_strength = (ema_9_val - ema_21_val) / ema_21_val
                        
            # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞
            if adx_value > 25 and abs(rsi_value - 50) > 20:
                mode = 'trend'
            elif adx_value < 20 and abs(rsi_value - 50) < 15:
                mode = 'range'
            elif volatility > 0.02:  # 2% –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å
                mode = 'volatile'
            else:
                mode = 'neutral'
                
            # –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            spacing_mult = 1.0 + volatility * 10
            grid_levels = max(4, min(8, int(6 / (1 + volatility * 10))))
            
            # –°–∏–ª–∞ —Ç—Ä–µ–Ω–¥–∞ (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è 0-1)
            trend_strength = adx_value / 100 if adx_value > 0 else 0
            
            return mode, spacing_mult, grid_levels, volatility, trend_strength, rsi_value, cci_value
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ä—ã–Ω–∫–∞ –¥–ª—è {symbol}: {e}")
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
            return 'neutral', 1.0, 6, 0.01, 0, 50, 0

    async def is_spread_acceptable(self, symbol):
        """–§–∏–ª—å—Ç—Ä –ø–æ —Å–ø—Ä–µ–¥—É"""
        try:
            ticker = await self.ex.fetch_ticker(symbol)
            bid = ticker['bid']
            ask = ticker['ask']
            if bid is None or ask is None:
                return False
            spread_pct = (ask - bid) / bid
            # –°–ø—Ä–µ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–µ–Ω—å—à–µ 0.1%
            return spread_pct < 0.001
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–ø—Ä–µ–¥–∞ –¥–ª—è {symbol}: {e}")
            return False

    async def create_reverse_grid(self, symbol):
        """–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–≤–µ—Ä—Å–∏–≤–Ω–æ–π —Å–µ—Ç–∫–∏ (–æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥)"""
        # === v2.0: –î–æ–±–∞–≤–ª–µ–Ω cooldown ===
        current_time = time.time()
        last_update = self.last_grid_updates.get(symbol, 0)
        cooldown_period = 60  # 1 –º–∏–Ω—É—Ç–∞
        
        if current_time - last_update < cooldown_period:
            self.logger.debug(f"‚è≥ {symbol}: –ü—Ä–æ–ø—É—â–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑-–∑–∞ cooldown")
            return
            
        self.last_grid_updates[symbol] = current_time
        # === /v2.0: –î–æ–±–∞–≤–ª–µ–Ω cooldown ===
        
        try:
            # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            if not await self.is_spread_acceptable(symbol):
                self.logger.info(f"‚ö†Ô∏è {symbol}: –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ç–∫–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ —Å–ø—Ä–µ–¥—É.")
                return
                
            # –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
            balances = await self.get_balances()
            symbol_balance = balances.get(symbol, {'base': 0, 'quote': 0})
            ticker = await self.ex.fetch_ticker(symbol)
            current_price = ticker['last']
            allocated_capital_for_symbol = self.allocated_capital.get(symbol, 0)
            
            # - –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1: –ò—Å–ø–æ–ª—å–∑—É–µ–º asset_equity_raw -
            base_equity = symbol_balance['base'] * current_price
            quote_equity = symbol_balance['quote']
            asset_equity_raw = base_equity + quote_equity
            # - /–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1 -
            
            # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–∞–ø–∏—Ç–∞–ª–∞
            if allocated_capital_for_symbol < self.config['grid']['min_order_usd'] * 2:
                self.logger.info(f"‚ö†Ô∏è {symbol}: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Ç–∫–∏ ({allocated_capital_for_symbol:.2f} USDT)")
                return
                
            # 3. –ê–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞
            ohlcv = await self.ex.fetch_ohlcv(symbol, '1m', limit=50)
            mode, spacing_mult, grid_levels, volatility, trend_strength, rsi, cci = await self.analyze_market_regime(symbol, ohlcv)
            
            # === v2.0: –î–æ–±–∞–≤–ª–µ–Ω CCI-–ø–æ—Ä–æ–≥ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ ===
            if cci < self.cci_block:
                self.logger.info(f"‚ö†Ô∏è {symbol}: –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ç–∫–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ CCI —Ñ–∏–ª—å—Ç—Ä–æ–º (CCI={cci:.2f} < {self.cci_block})")
                return
            # === /v2.0: –î–æ–±–∞–≤–ª–µ–Ω CCI-–ø–æ—Ä–æ–≥ ===
                
            # 4. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–µ—Ç–∫–∏
            base_spacing = self.config['grid']['base_spacing']
            adjusted_spacing = base_spacing * spacing_mult
            max_levels = self.config['grid']['max_levels']
            actual_levels = min(grid_levels, max_levels)
            
            # 5. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—ä–µ–º –Ω–∞ —É—Ä–æ–≤–µ–Ω—å
            total_orders = actual_levels * 2  # BUY –∏ SELL —É—Ä–æ–≤–Ω–∏
            capital_per_order = allocated_capital_for_symbol / total_orders if total_orders > 0 else 0
            
            if capital_per_order <= 0:
                self.logger.warning(f"‚ö†Ô∏è {symbol}: –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –æ–±—ä–µ–º –æ—Ä–¥–µ—Ä–∞")
                return
                
            # === v2.0: –î–æ–±–∞–≤–ª–µ–Ω —Ä–µ–∂–∏–º futures ===
            if self.grid_mode == 'futures':
                # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–µ–∂–∏–º–∞ –ø–æ–∑–∏—Ü–∏–π –¥–ª—è —Ñ—å—é—á–µ—Ä—Å–æ–≤
                try:
                    await self.ex.set_position_mode(hedged=True)  # OKX specific
                    self.logger.info(f"üéõÔ∏è {symbol}: –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ä–µ–∂–∏–º –ø–æ–∑–∏—Ü–∏–π hedged –¥–ª—è futures")
                except Exception as e:
                    self.logger.warning(f"‚ö†Ô∏è {symbol}: –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–µ–∂–∏–º –ø–æ–∑–∏—Ü–∏–π futures: {e}")
            # === /v2.0: –î–æ–±–∞–≤–ª–µ–Ω —Ä–µ–∂–∏–º futures ===
            
            # 6. –°–æ–∑–¥–∞–µ–º BUY —É—Ä–æ–≤–Ω–∏ (LONG)
            buy_prices = []
            for i in range(actual_levels):
                price_level = current_price * (1 - adjusted_spacing * (i + 1))
                buy_prices.append(price_level)
                
            # 7. –°–æ–∑–¥–∞–µ–º SELL —É—Ä–æ–≤–Ω–∏
            sell_prices = []
            # === v2.0: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω Sell-—É—Ä–æ–≤–Ω–∏ –¥–ª—è spot ===
            if self.grid_mode == 'spot':
                # –î–ª—è spot –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –±–∞–∑–æ–≤–æ–≥–æ –∞–∫—Ç–∏–≤–∞
                balance = await self.get_balances()
                base_asset = symbol.split('/')[0]
                base_balance = balance.get(symbol, {}).get('base', 0) # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π –±–∞–ª–∞–Ω—Å
                
                if base_balance <= 0:
                    self.logger.warning(f"‚ö†Ô∏è {symbol}: –ù–µ—Ç –±–∞–∑–æ–≤–æ–≥–æ –∞–∫—Ç–∏–≤–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è SELL –æ—Ä–¥–µ—Ä–æ–≤ –≤ spot —Ä–µ–∂–∏–º–µ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ. –°–æ–∑–¥–∞–µ–º —Å–µ—Ç–∫—É —Ç–æ–ª—å–∫–æ BUY.")
                else:
                    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ –Ω–∞ –∫–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å
                    amount_per_sell_level = base_balance / actual_levels if actual_levels > 0 else 0
                    if amount_per_sell_level > 0:
                        for i in range(actual_levels):
                            price_level = current_price * (1 + adjusted_spacing * (i + 1))
                            sell_prices.append(price_level)
            else:
                # –î–ª—è futures —Å–æ–∑–¥–∞–µ–º SELL —É—Ä–æ–≤–Ω–∏ –∫–∞–∫ –æ–±—ã—á–Ω–æ
                for i in range(actual_levels):
                    price_level = current_price * (1 + adjusted_spacing * (i + 1))
                    sell_prices.append(price_level)
            # === /v2.0: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω Sell-—É—Ä–æ–≤–Ω–∏ ===
            
            # 8. –û—Ç–º–µ–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ—Ä–¥–µ—Ä–∞ –ø–æ —ç—Ç–æ–π –ø–∞—Ä–µ
            if symbol in self.asset_grids:
                existing_orders = list(self.asset_grids[symbol].items())
                cancel_tasks = []
                for order_id, order_info in existing_orders:
                    try:
                        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ—Ç–æ–¥ cancel_order –Ω–∞–ø—Ä—è–º—É—é
                        cancel_task = asyncio.create_task(self.ex.cancel_order(order_id, symbol))
                        cancel_tasks.append(cancel_task)
                        self.logger.info(f"‚ùå {symbol}: –û—Ç–º–µ–Ω—ë–Ω –æ—Ä–¥–µ—Ä #{order_id}")
                        del self.asset_grids[symbol][order_id]
                    except ccxt.OrderNotFound:
                        # –û—Ä–¥–µ—Ä —É–∂–µ –æ—Ç–º–µ–Ω–µ–Ω –∏–ª–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω
                        if order_id in self.asset_grids[symbol]:
                            del self.asset_grids[symbol][order_id]
                        self.logger.debug(f"–û—Ä–¥–µ—Ä {order_id} –¥–ª—è {symbol} –Ω–µ –Ω–∞–π–¥–µ–Ω –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ (–≤–æ–∑–º–æ–∂–Ω–æ, —É–∂–µ –∏—Å–ø–æ–ª–Ω–µ–Ω)")
                    except Exception as e:
                        self.logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –æ—Ä–¥–µ—Ä–∞ {order_id} –¥–ª—è {symbol}: {e}")
                        
                # if cancel_tasks:
                #     results = await asyncio.gather(*cancel_tasks, return_exceptions=True)
                #     successful_cancels = sum(1 for r in results if not isinstance(r, Exception))
                #     self.logger.info(f"‚úÖ –û—Ç–º–µ–Ω–µ–Ω–æ {successful_cancels} –æ—Ä–¥–µ—Ä–æ–≤ –¥–ª—è {symbol}")
                        
            # 9. –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ –æ—Ä–¥–µ—Ä–∞
            new_orders = {}
            
            # BUY –æ—Ä–¥–µ—Ä–∞
            for i, buy_price in enumerate(buy_prices):
                try:
                    amount_usd = capital_per_order
                    amount_asset = amount_usd / buy_price
                    
                    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –ª–æ—Ç–∞
                    if not await self.check_min_lot(symbol, amount_asset, buy_price):
                        continue
                        
                    order = await self.ex.create_limit_buy_order(symbol, amount_asset, buy_price)
                    order_id = order['id']
                    
                    new_orders[order_id] = {
                        'type': 'buy',
                        'price': buy_price,
                        'amount': amount_asset,
                        'level': i+1,
                        'mode': mode
                    }
                    
                    self.logger.info(f"üìâ {symbol} BUY –æ—Ä–¥–µ—Ä #{order_id}: {amount_asset:.6f} @ {buy_price:.2f} (${amount_usd:.2f})")
                except ccxt.InsufficientFunds as e:
                    self.logger.warning(f"‚ö†Ô∏è {symbol} –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è BUY –æ—Ä–¥–µ—Ä–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ {i+1}: {e}")
                    break
                except Exception as e:
                    self.logger.error(f"‚ùå –û—à–∏–±–∫–∞ BUY –æ—Ä–¥–µ—Ä–∞ {symbol} –Ω–∞ —É—Ä–æ–≤–Ω–µ {i+1}: {e}")
                    
            # SELL –æ—Ä–¥–µ—Ä–∞
            for i, sell_price in enumerate(sell_prices):
                try:
                    if self.grid_mode == 'spot':
                        # –î–ª—è spot –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—ã–π –±–∞–ª–∞–Ω—Å
                        balance = await self.get_balances()
                        symbol_balance = balance.get(symbol, {'base': 0, 'quote': 0})
                        base_balance = symbol_balance['base']
                        amount_per_sell_level = base_balance / len(sell_prices) if len(sell_prices) > 0 else 0
                        
                        if amount_per_sell_level <= 0:
                            continue
                            
                        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –ª–æ—Ç–∞
                        if not await self.check_min_lot(symbol, amount_per_sell_level, sell_price):
                            continue
                            
                        order = await self.ex.create_limit_sell_order(symbol, amount_per_sell_level, sell_price)
                    else:
                        # –î–ª—è futures —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–∫ –¥–ª—è LONG –ø–æ–∑–∏—Ü–∏–∏
                        amount_usd = capital_per_order
                        amount_asset = amount_usd / sell_price
                        
                        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –ª–æ—Ç–∞
                        if not await self.check_min_lot(symbol, amount_asset, sell_price):
                            continue
                            
                        order = await self.ex.create_limit_sell_order(symbol, amount_asset, sell_price)
                        
                    order_id = order['id']
                    
                    new_orders[order_id] = {
                        'type': 'sell',
                        'price': sell_price,
                        'amount': amount_per_sell_level if self.grid_mode == 'spot' else amount_asset,
                        'level': i+1,
                        'mode': mode
                    }
                    
                    self.logger.info(f"üìà {symbol} SELL –æ—Ä–¥–µ—Ä #{order_id}: {new_orders[order_id]['amount']:.6f} @ {sell_price:.2f}")
                except ccxt.InsufficientFunds as e:
                    self.logger.warning(f"‚ö†Ô∏è {symbol} –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è SELL –æ—Ä–¥–µ—Ä–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ {i+1}: {e}")
                    break
                except Exception as e:
                    self.logger.error(f"‚ùå –û—à–∏–±–∫–∞ SELL –æ—Ä–¥–µ—Ä–∞ {symbol} –Ω–∞ —É—Ä–æ–≤–Ω–µ {i+1}: {e}")
                    
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–æ–≤—ã—Ö –æ—Ä–¥–µ—Ä–∞—Ö
            self.asset_grids[symbol] = new_orders
            self.logger.info(f"üîß {symbol} Grid: Buy {len(buy_prices)} | Sell {len(sell_prices)}")
            
        except Exception as e:
            self.logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Ç–∫–∏ –¥–ª—è {symbol}: {e}")

    async def check_all_orders(self):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –æ—Ä–¥–µ—Ä–æ–≤"""
        for symbol in list(self.asset_grids.keys()):
            try:
                open_orders = await self.ex.fetch_open_orders(symbol)
                open_order_ids = {order['id'] for order in open_orders}
            except Exception as e:
                self.logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ä–¥–µ—Ä–æ–≤ –¥–ª—è {symbol}: {e}")
                continue
                
            executed_orders = []
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–∏—Å–æ–∫ –¥–ª—è –∏—Ç–µ—Ä–∞—Ü–∏–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–ª–æ–≤–∞—Ä—è –≤–æ –≤—Ä–µ–º—è –∏—Ç–µ—Ä–∞—Ü–∏–∏
            current_grid_orders = list(self.asset_grids[symbol].items())
            
            for order_id, order_info in current_grid_orders:
                if order_id not in open_order_ids and order_id not in self.executed_order_ids:
                    # –û—Ä–¥–µ—Ä –∏—Å–ø–æ–ª–Ω–µ–Ω
                    executed_orders.append((order_id, order_info))
                    self.executed_order_ids.append(order_id)
                    self.logger.info(f"‚úÖ {symbol}: –ò—Å–ø–æ–ª–Ω–µ–Ω –æ—Ä–¥–µ—Ä #{order_id} ({order_info['type']})")
                    
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤
            for order_id, order_info in executed_orders:
                # –£–¥–∞–ª—è–µ–º –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤
                if order_id in self.asset_grids[symbol]:
                    del self.asset_grids[symbol][order_id]
                    
                # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 1: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –æ—Ä–¥–µ—Ä–∞ -
                trade_event = TradeEvent(
                    ts=time.time(),
                    symbol=symbol,
                    side=order_info['type'],
                    price=order_info['price'],
                    qty=order_info['amount']
                )
                # await self.log_trade(trade_event) # –£–∂–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –Ω–∏–∂–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≤—Å—Ç—Ä–µ—á–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞
                # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 1 -
                
                # –°–æ–∑–¥–∞–µ–º –≤—Å—Ç—Ä–µ—á–Ω—ã–π –æ—Ä–¥–µ—Ä
                try:
                    if order_info['type'] == 'buy':
                        # –°–æ–∑–¥–∞–µ–º SELL –æ—Ä–¥–µ—Ä (Take Profit)
                        tp_price = order_info['price'] * (1 + self.config['grid']['base_spacing'])
                        tp_amount = order_info['amount']
                        
                        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –ª–æ—Ç–∞
                        if await self.check_min_lot(symbol, tp_amount, tp_price):
                            tp_order = await self.ex.create_limit_sell_order(symbol, tp_amount, tp_price)
                            tp_order_id = tp_order['id']
                            
                            self.asset_grids[symbol][tp_order_id] = {
                                'type': 'sell',
                                'price': tp_price,
                                'amount': tp_amount,
                                'level': order_info['level'],
                                'mode': order_info['mode']
                            }
                            
                            # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 5: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è TP SELL –æ—Ä–¥–µ—Ä–∞ -
                            self.logger.info(f"üéØ {symbol} TP SELL –æ—Ä–¥–µ—Ä #{tp_order_id}: {tp_amount:.6f} @ {tp_price:.2f}")
                            # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 5 -
                            
                    elif order_info['type'] == 'sell':
                        # –°–æ–∑–¥–∞–µ–º BUY –æ—Ä–¥–µ—Ä (Take Profit)
                        tp_price = order_info['price'] * (1 - self.config['grid']['base_spacing'])
                        tp_amount = order_info['amount']
                        
                        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –ª–æ—Ç–∞
                        if await self.check_min_lot(symbol, tp_amount, tp_price):
                            # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤ USDT
                            tp_amount_usd = tp_amount * tp_price
                            
                            tp_order = await self.ex.create_limit_buy_order(symbol, tp_amount, tp_price)
                            tp_order_id = tp_order['id']
                            
                            self.asset_grids[symbol][tp_order_id] = {
                                'type': 'buy',
                                'price': tp_price,
                                'amount': tp_amount,
                                'level': order_info['level'],
                                'mode': order_info['mode']
                            }
                            
                            # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 5: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è TP BUY –æ—Ä–¥–µ—Ä–∞ -
                            self.logger.info(f"üéØ {symbol} TP BUY –æ—Ä–¥–µ—Ä #{tp_order_id}: {tp_amount:.6f} @ {tp_price:.2f} (${tp_amount_usd:.2f})")
                            # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 5 -
                            
                except Exception as e:
                    self.logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤—Å—Ç—Ä–µ—á–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞ –¥–ª—è {symbol}: {e}")

    # v2.0: –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ –∑–∞–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π
    async def close_all_positions(self):
        """
        v2.0: –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ –∑–∞–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π –∏ –æ—Ç–º–µ–Ω—ã –æ—Ä–¥–µ—Ä–æ–≤.
        """
        self.logger.info("üö™ –ù–∞—á–∞–ª–æ –∑–∞–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π Grid-–±–æ—Ç–∞...")
        
        # –û—Ç–º–µ–Ω–∞ –≤—Å–µ—Ö –æ—Ç–∫—Ä—ã—Ç—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤
        for symbol in list(self.asset_grids.keys()):
            existing_orders = list(self.asset_grids[symbol].items())
            for order_id, order_info in existing_orders:
                try:
                    await self.ex.cancel_order(order_id, symbol)
                    self.logger.info(f"‚ùå {symbol}: –û—Ç–º–µ–Ω—ë–Ω –æ—Ä–¥–µ—Ä #{order_id} –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏")
                except Exception as e:
                    self.logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –æ—Ä–¥–µ—Ä–∞ {order_id} –¥–ª—è {symbol}: {e}")
        
        # –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π (–¥–ª—è futures)
        if self.grid_mode == 'futures':
            try:
                positions = await self.ex.fetch_positions()
                for position in positions:
                    symbol = position['symbol']
                    side = position['side']
                    amount = position['contracts']
                    
                    if amount > 0:
                        close_side = 'sell' if side == 'long' else 'buy'
                        try:
                            # –°–æ–∑–¥–∞–µ–º —Ä—ã–Ω–æ—á–Ω—ã–π –æ—Ä–¥–µ—Ä –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏
                            if close_side == 'sell':
                                await self.ex.create_market_sell_order(symbol, amount)
                            else:
                                await self.ex.create_market_buy_order(symbol, amount)
                            self.logger.info(f"üö™ {symbol}: –ó–∞–∫—Ä—ã—Ç–∞ –ø–æ–∑–∏—Ü–∏—è {side} {amount}")
                        except Exception as e:
                            self.logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ {symbol} {side}: {e}")
            except Exception as e:
                self.logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è: {e}")
        else:
            # –î–ª—è spot —Ä–µ–∂–∏–º–∞ –ø—Ä–æ—Å—Ç–æ –æ—Ç–º–µ–Ω—è–µ–º –æ—Ä–¥–µ—Ä–∞, –ø–æ–∑–∏—Ü–∏–π –∫–∞–∫ —Ç–∞–∫–æ–≤—ã—Ö –Ω–µ—Ç
            # –ù–æ –µ—Å–ª–∏ —É –Ω–∞—Å –µ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–µ –ª–æ–Ω–≥–∏ (BUY –æ—Ä–¥–µ—Ä–∞ –∏—Å–ø–æ–ª–Ω–∏–ª–∏—Å—å), –º—ã –º–æ–≥–ª–∏ –±—ã –∏—Ö –∑–∞–∫—Ä—ã—Ç—å —Ä—ã–Ω–æ—á–Ω–æ
            # –û–¥–Ω–∞–∫–æ, –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –Ω–µ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç —ç—Ç–æ–≥–æ. –ü—Ä–æ—Å—Ç–æ –æ—Ç–º–µ–Ω—è–µ–º –æ—Ä–¥–µ—Ä–∞.
            self.logger.info("üì≠ Spot —Ä–µ–∂–∏–º: –æ—Ä–¥–µ—Ä–∞ –æ—Ç–º–µ–Ω–µ–Ω—ã, –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π –Ω–µ—Ç (–∏–ª–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è —Ä—ã–Ω–æ—á–Ω—ã–º–∏ –æ—Ä–¥–µ—Ä–∞–º–∏ –ø—Ä–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–∏ —Å–µ—Ç–∫–∏)")
            
        self.logger.info("‚úÖ –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π Grid-–±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.")

    # - –ú–µ—Ç–æ–¥ execute_strategy –¥–ª—è Grid-–±–æ—Ç–∞ -
    async def execute_strategy(self):
        """–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ç–æ—Ä–≥–æ–≤–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–ª—è Grid-–±–æ—Ç–∞"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ä–¥–µ—Ä–æ–≤
        await self.check_all_orders()
        
        # –°–æ–∑–¥–∞–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Ç–∫–∏ –¥–ª—è –∞–∫—Ç–∏–≤–æ–≤
        for symbol in self.symbols:
            await self.create_reverse_grid(symbol)
    # - /–ú–µ—Ç–æ–¥ execute_strategy –¥–ª—è Grid-–±–æ—Ç–∞ -

    # v2.0: –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Ç–æ–¥–∞ graceful shutdown
    async def _shutdown(self):
        """
        v2.0: –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ graceful shutdown –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–π.
        """
        self.logger.info("üõë –ù–∞—á–∞–ª–æ graceful shutdown Grid-–±–æ—Ç–∞...")
        await self.close_all_positions()
        # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ IPC —Å–µ—Ä–≤–µ—Ä–∞
        if self.ipc_server:
            await self.ipc_server.stop()
        self.running = False
        self.logger.info("üõë Graceful shutdown Grid-–±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω.")

    async def run(self):
        """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞"""
        try:
            await self.ex.load_markets()
            await self.update_capital()
            
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ø–∏—Ç–∞–ª–∞
            self.working_capital = self.total_capital * 0.5
            self.reserve_capital = self.total_capital * 0.5
            self.logger.info(f"üí∞ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ø–∏—Ç–∞–ª–∞: –í—Å–µ–≥–æ=${self.total_capital:.2f}, –†–∞–±–æ—á–∏–π=${self.working_capital:.2f}, –†–µ–∑–µ—Ä–≤=${self.reserve_capital:.2f}")
            
            # v2.0: –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Ç–æ–¥–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞–ø–∏—Ç–∞–ª–∞
            await self.distribute_capital()
            
            # - –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1: –ó–∞–ø—É—Å–∫ —Ü–∏–∫–ª–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ -
            # asyncio.create_task(self._daily_report_loop())
            # - /–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1 -
            
            self.logger.info(f"üü¢ Grid Bot –∑–∞–ø—É—â–µ–Ω. –ù–∞—á–∞–ª—å–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª: {self.total_capital:.2f} USDT")
            await self.send(f"üü¢ Grid Bot –∑–∞–ø—É—â–µ–Ω. –ö–∞–ø–∏—Ç–∞–ª: {self.total_capital:.2f} USDT")
            
            # - –î–û–ë–ê–í–õ–ï–ù–ò–ï 7: –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å—Ç–∞—Ä—Ç–µ -
            await self._send_start_notification()
            # - /–î–û–ë–ê–í–õ–ï–ù–ò–ï 7 -
            
            # –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
            while self.running:
                try:
                    await self.update_capital()
                    
                    # –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–∞
                    current_time = time.time()
                    if current_time - self.last_redistribution > self.redistribution_interval:
                        await self.distribute_capital()
                        self.last_redistribution = current_time
                        
                    # - –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2: –°–Ω–∞–ø—à–æ—Ç –ø–æ—Ä—Ç—Ñ–µ–ª—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç -
                    # if int(time.time()) % 300 == 0:
                    #     await self._log_portfolio_snapshot()
                    # - /–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2 -
                    
                    # –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ –±–æ—Ç–∞
                    await self.execute_strategy()
                    
                    # –ü–∞—É–∑–∞
                    sleep_interval = self.config['grid']['sleep_interval']
                    await asyncio.sleep(sleep_interval)
                    
                except ccxt.NetworkError as e:
                    self.logger.error(f"–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: {e}")
                    await asyncio.sleep(10)
                except ccxt.ExchangeError as e:
                    self.logger.error(f"–ë–∏—Ä–∂–µ–≤–∞—è –æ—à–∏–±–∫–∞: {e}")
                    await asyncio.sleep(sleep_interval * 2)
                except Exception as e:
                    self.logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ü–∏–∫–ª–µ Grid: {e}")
                    await asyncio.sleep(sleep_interval * 3)
                    
        except Exception as e:
            self.logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        finally:
            await self._shutdown()

    def exit_gracefully(self, signum, frame):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è graceful shutdown"""
        self.logger.info(f"üõë Grid graceful shutdown (—Å–∏–≥–Ω–∞–ª {signum})")
        self.running = False

    # v2.0: –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Ç–æ–¥–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞–ø–∏—Ç–∞–ª–∞
    async def distribute_capital(self):
        """
        –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–æ–¥ –∏–∑ –±–∞–∑–æ–≤–æ–≥–æ –∫–ª–∞—Å—Å–∞ –¥–ª—è Grid-–±–æ—Ç–∞.
        v2.0: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç CapitalDistributor –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è.
        """
        self.logger.info("üîÑ –ù–∞—á–∞–ª–æ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞–ø–∏—Ç–∞–ª–∞ –¥–ª—è Grid...")
        
        # v2.0: –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π –º–æ–¥—É–ª—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞–ø–∏—Ç–∞–ª–∞
        distributor = CapitalDistributor(self.ex)
        allocations = await distributor.distribute_for_strategy('grid', self.symbols)
        
        self.allocated_capital = allocations
        
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
        for symbol, amount in self.allocated_capital.items():
            self.logger.info(f"üí∞ {symbol}: –≤—ã–¥–µ–ª–µ–Ω–æ ${amount:.2f} USDT")
            
        self.logger.info("‚úÖ –ü–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–∞ –¥–ª—è Grid –∑–∞–≤–µ—Ä—à–µ–Ω–æ.")

# - –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ -
async def main():
    bot = MultiAssetGridBot()
    
    # –ó–∞–ø—É—Å–∫ IPC —Å–µ—Ä–≤–µ—Ä–∞
    if bot.ipc_server:
        await bot.ipc_server.start()
        
    await bot.run()

if __name__ == "__main__":
    if not os.path.exists('.env'):
        print("‚ùå –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        print("–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env —Å –≤–∞—à–∏–º–∏ API –∫–ª—é—á–∞–º–∏")
        sys.exit(1)
        
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("üõë –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        logging.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
# - /–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ -

