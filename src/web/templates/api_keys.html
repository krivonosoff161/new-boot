{% extends "base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ API –ö–ª—é—á–∞–º–∏{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h1 class="mb-4">üîë –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ API –ö–ª—é—á–∞–º–∏ –ë–∏—Ä–∂</h1>
            
            <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∫–ª—é—á–µ–π -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ API –∫–ª—é—á–∏</h5>
                </div>
                <div class="card-body">
                    <form id="addApiKeyForm">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="exchange" class="form-label">–ë–∏—Ä–∂–∞</label>
                                <select class="form-select" id="exchange" name="exchange" required>
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±–∏—Ä–∂—É</option>
                                    {% for exchange in supported_exchanges %}
                                    <option value="{{ exchange }}">{{ exchange | title }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="mode" class="form-label">–†–µ–∂–∏–º</label>
                                <select class="form-select" id="mode" name="mode" required>
                                    <option value="sandbox">Sandbox (–¢–µ—Å—Ç)</option>
                                    <option value="live">Live (–†–µ–∞–ª—å–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è)</option>
                                </select>
                            </div>
                            <div class="col-md-7">
                                <label for="api_key" class="form-label">API –ö–ª—é—á</label>
                                <input type="text" class="form-control" id="api_key" name="api_key" required>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label for="secret" class="form-label">–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á</label>
                                <input type="password" class="form-control" id="secret" name="secret" required>
                            </div>
                            <div class="col-md-4">
                                <label for="passphrase" class="form-label">–ü–∞—Ä–æ–ª—å (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)</label>
                                <input type="password" class="form-control" id="passphrase" name="passphrase">
                                <small class="form-text text-muted">–¢—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –±–∏—Ä–∂ (OKX, Coinbase Pro)</small>
                                <small id="okx-required" class="form-text text-danger" style="display: none;">‚ö†Ô∏è –î–ª—è OKX –ø–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω!</small>
                                <div id="okx-hint" class="alert alert-info mt-2" style="display: none;">
                                    <strong>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è OKX:</strong><br>
                                    ‚Ä¢ <strong>–í–∞–∂–Ω–æ:</strong> OKX –Ω–µ –∏–º–µ–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–π –¥–µ–º–æ-—Å—Ä–µ–¥—ã<br>
                                    ‚Ä¢ –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ <strong>Live –∫–ª—é—á–∏</strong> —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏<br>
                                    ‚Ä¢ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ API –∫–ª—é—á–∏ –∏–º–µ—é—Ç –ø—Ä–∞–≤–∞ –Ω–∞ —Ç–æ—Ä–≥–æ–≤–ª—é<br>
                                    ‚Ä¢ <strong>Password</strong> - —ç—Ç–æ –ø–∞—Ä–æ–ª—å, –∫–æ—Ç–æ—Ä—ã–π –≤—ã —Å–æ–∑–¥–∞–ª–∏ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ API –∫–ª—é—á–µ–π (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)<br>
                                    ‚Ä¢ OKX –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ–ª–µ "Password", –∞ –Ω–µ "Passphrase"
                                </div>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100">–î–æ–±–∞–≤–∏—Ç—å</button>
                            </div>
                        </div>
                    </form>
                    <div id="add-result" class="mt-3"></div>
                </div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–ª—é—á–µ–π -->
            <div class="card">
                <div class="card-header">
                    <h5>üìã –í–∞—à–∏ API –∫–ª—é—á–∏</h5>
                </div>
                <div class="card-body">
                    {% if keys %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>–ë–∏—Ä–∂–∞</th>
                                        <th>–†–µ–∂–∏–º</th>
                                        <th>API –ö–ª—é—á</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                        <th>–°–æ–∑–¥–∞–Ω</th>
                                        <th>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for key in keys %}
                                    <tr id="key-{{ key.key_id }}">
                                        <td>
                                            <span class="badge bg-primary">{{ key.exchange | title }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'warning' if key.mode == 'sandbox' else 'success' }}">
                                                {{ '–¢–µ—Å—Ç' if key.mode == 'sandbox' else '–†–µ–∞–ª—å–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è' }}
                                            </span>
                                        </td>
                                        <td>
                                            <code>{{ key.api_key_preview }}</code>
                                        </td>
                                        <td>
                                            {% if key.validation_status == 'valid' %}
                                                <span class="badge bg-success">‚úÖ –í–∞–ª–∏–¥–Ω—ã</span>
                                            {% elif key.validation_status == 'invalid' %}
                                                <span class="badge bg-danger">‚ùå –ù–µ–≤–∞–ª–∏–¥–Ω—ã</span>
                                            {% else %}
                                                <span class="badge bg-secondary">‚è≥ –ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ key.created_at[:10] }}</small>
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                {{ key.last_used[:16] if key.last_used else '–ù–∏–∫–æ–≥–¥–∞' }}
                                            </small>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button class="btn btn-outline-info" onclick="validateKey('{{ key.key_id }}')" 
                                                        title="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª—é—á–∏">
                                                    üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
                                                </button>
                                                <button class="btn btn-outline-danger" onclick="deleteKey('{{ key.key_id }}')" 
                                                        title="–£–¥–∞–ª–∏—Ç—å –∫–ª—é—á–∏">
                                                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <p class="text-muted">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö API –∫–ª—é—á–µ–π</p>
                            <p class="text-muted">–î–æ–±–∞–≤—å—Ç–µ –∫–ª—é—á–∏ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∏—Ä–∂–∞–º</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö API –∫–ª—é—á–µ–π
document.getElementById('addApiKeyForm').addEventListener('submit', function(event) {
    event.preventDefault();
    
    const formData = {
        exchange: document.getElementById('exchange').value,
        mode: document.getElementById('mode').value,
        api_key: document.getElementById('api_key').value,
        secret: document.getElementById('secret').value,
        passphrase: document.getElementById('passphrase').value
    };
    
    fetch('/api/api-keys', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        const resultDiv = document.getElementById('add-result');
        if (data.success) {
            resultDiv.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
            document.getElementById('addApiKeyForm').reset();
            setTimeout(() => location.reload(), 1500);
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('add-result').innerHTML = 
            `<div class="alert alert-danger">–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–ª—é—á–µ–π</div>`;
    });
});

// –í–∞–ª–∏–¥–∞—Ü–∏—è API –∫–ª—é—á–µ–π
function validateKey(keyId) {
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º...';
    button.disabled = true;
    
    fetch(`/api/api-keys/${keyId}/validate`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message || '‚úÖ –ö–ª—é—á–∏ —É—Å–ø–µ—à–Ω–æ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω—ã!');
        } else {
            let errorMessage = `–û—à–∏–±–∫–∞: ${data.error}`;
            if (data.technical_error) {
                errorMessage += `<br><small class="text-muted">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${data.technical_error}</small>`;
            }
            showAlert('danger', errorMessage);
        }
        setTimeout(() => location.reload(), 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–ª—é—á–µ–π');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// –£–¥–∞–ª–µ–Ω–∏–µ API –∫–ª—é—á–µ–π
function deleteKey(keyId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–∏ API –∫–ª—é—á–∏? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
        return;
    }
    
    fetch(`/api/api-keys/${keyId}/delete`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert('danger', `–û—à–∏–±–∫–∞: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–ª—é—á–µ–π');
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container');
    container.insertBefore(alertDiv, container.firstChild);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏
document.addEventListener('DOMContentLoaded', function() {
    const modeSelect = document.getElementById('mode');
    const exchangeSelect = document.getElementById('exchange');
    const liveWarning = document.createElement('div');
    const okxHint = document.getElementById('okx-hint');
    
    liveWarning.className = 'alert alert-warning mt-2';
    liveWarning.style.display = 'none';
    liveWarning.innerHTML = `
        <strong>‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ!</strong> –í—ã –≤—ã–±—Ä–∞–ª–∏ —Ä–µ–∂–∏–º —Ä–µ–∞–ª—å–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–ª–∏. 
        –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ API –∫–ª—é—á–∏ –∏–º–µ—é—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∞ (—Ç–æ–ª—å–∫–æ —Ç–æ—Ä–≥–æ–≤–ª—è, –±–µ–∑ –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤).
    `;
    
    document.getElementById('mode').parentNode.appendChild(liveWarning);
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞
    modeSelect.addEventListener('change', function() {
        if (this.value === 'live') {
            liveWarning.style.display = 'block';
        } else {
            liveWarning.style.display = 'none';
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∏—Ä–∂–∏
    exchangeSelect.addEventListener('change', function() {
        const passphraseInput = document.getElementById('passphrase');
        const okxRequired = document.getElementById('okx-required');
        const modeSelect = document.getElementById('mode');
        
        if (this.value === 'okx') {
            okxHint.style.display = 'block';
            okxRequired.style.display = 'block';
            passphraseInput.required = true;
            
            // –î–ª—è OKX —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º Live —Ä–µ–∂–∏–º
            modeSelect.value = 'live';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –¥–ª—è OKX –Ω—É–∂–µ–Ω Live —Ä–µ–∂–∏–º
            const okxModeWarning = document.createElement('div');
            okxModeWarning.className = 'alert alert-warning mt-2';
            okxModeWarning.id = 'okx-mode-warning';
            okxModeWarning.innerHTML = `
                <strong>‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ!</strong> –î–ª—è OKX —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Live —Ä–µ–∂–∏–º, 
                —Ç–∞–∫ –∫–∞–∫ OKX –Ω–µ –∏–º–µ–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–π –¥–µ–º–æ-—Å—Ä–µ–¥—ã.
            `;
            
            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
            const existingWarning = document.getElementById('okx-mode-warning');
            if (existingWarning) {
                existingWarning.remove();
            }
            
            modeSelect.parentNode.appendChild(okxModeWarning);
            
        } else {
            okxHint.style.display = 'none';
            okxRequired.style.display = 'none';
            passphraseInput.required = false;
            
            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ OKX
            const okxModeWarning = document.getElementById('okx-mode-warning');
            if (okxModeWarning) {
                okxModeWarning.remove();
            }
        }
    });
});
</script>
{% endblock %}
