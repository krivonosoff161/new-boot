{% extends "base.html" %}

{% block title %}Enhanced Trading Dashboard{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="mb-0">üöÄ Enhanced Trading Dashboard</h1>
            <p class="text-muted">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <strong id="username">{{ current_user.username }}</strong>! 
            –í–∞—à–∞ —Ä–æ–ª—å: <span class="badge bg-primary" id="user-role">{{ current_user.role }}</span></p>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title" id="total-bots">0</h4>
                            <p class="card-text">–í—Å–µ–≥–æ –±–æ—Ç–æ–≤</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-robot fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title" id="running-bots">0</h4>
                            <p class="card-text">–ó–∞–ø—É—â–µ–Ω–Ω—ã—Ö –±–æ—Ç–æ–≤</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-play-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title" id="valid-keys">0</h4>
                            <p class="card-text">–í–∞–ª–∏–¥–Ω—ã—Ö API –∫–ª—é—á–µ–π</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-key fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title" id="total-exchanges">0</h4>
                            <p class="card-text">–ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –±–∏—Ä–∂</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-exchange-alt fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="row">
        <!-- –ë–æ—Ç—ã -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">ü§ñ –í–∞—à–∏ —Ç–æ—Ä–≥–æ–≤—ã–µ –±–æ—Ç—ã</h5>
                    <a href="/bots" class="btn btn-sm btn-outline-primary">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</a>
                </div>
                <div class="card-body">
                    <div id="bots-list">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                            </div>
                            <p class="mt-2 text-muted">–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –±–æ—Ç–∞—Ö...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ë–∞–ª–∞–Ω—Å—ã -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üí∞ –ë–∞–ª–∞–Ω—Å—ã –Ω–∞ –±–∏—Ä–∂–∞—Ö</h5>
                    <a href="/api-keys" class="btn btn-sm btn-outline-primary">API –ö–ª—é—á–∏</a>
                </div>
                <div class="card-body">
                    <div id="balances-list">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                            </div>
                            <p class="mt-2 text-muted">–ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–ª–∞–Ω—Å—ã...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-2">
                            <a href="/bots" class="btn btn-primary w-100">
                                <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –±–æ—Ç–∞
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="/api-keys" class="btn btn-success w-100">
                                <i class="fas fa-key"></i> –î–æ–±–∞–≤–∏—Ç—å API –∫–ª—é—á–∏
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <button class="btn btn-info w-100" onclick="refreshDashboard()">
                                <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                            </button>
                        </div>
                        {% if current_user.role in ['admin', 'super_admin'] %}
                        <div class="col-md-3 mb-2">
                            <a href="/admin" class="btn btn-warning w-100">
                                <i class="fas fa-cog"></i> –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö –±–∞–ª–∞–Ω—Å–æ–≤ -->
<div class="modal fade" id="balancesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="balancesModalTitle">–ë–∞–ª–∞–Ω—Å—ã</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="balancesModalContent">
                    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let dashboardData = {
    stats: null,
    bots: [],
    balances: []
};

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–∞—à–±–æ—Ä–¥–∞
async function loadDashboardData() {
    try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        const statsResponse = await fetch('/api/dashboard/stats');
        const statsData = await statsResponse.json();
        
        if (statsData.success) {
            dashboardData.stats = statsData.stats;
            updateStatsCards(statsData.stats);
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –±–æ—Ç–∞—Ö
        const botsResponse = await fetch('/api/dashboard/bots');
        const botsData = await botsResponse.json();
        
        if (botsData.success) {
            dashboardData.bots = botsData.bots;
            updateBotsList(botsData.bots);
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–ª–∞–Ω—Å—ã
        const balancesResponse = await fetch('/api/dashboard/balances');
        const balancesData = await balancesResponse.json();
        
        if (balancesData.success) {
            dashboardData.balances = balancesData.balances;
            updateBalancesList(balancesData.balances);
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–∞—à–±–æ—Ä–¥–∞:', error);
        showAlert('danger', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–∞—à–±–æ—Ä–¥–∞');
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
function updateStatsCards(stats) {
    document.getElementById('total-bots').textContent = stats.bots.total;
    document.getElementById('running-bots').textContent = stats.bots.running;
    document.getElementById('valid-keys').textContent = stats.api_keys.valid;
    document.getElementById('total-exchanges').textContent = stats.api_keys.exchanges.length;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –±–æ—Ç–æ–≤
function updateBotsList(bots) {
    const botsList = document.getElementById('bots-list');
    
    if (bots.length === 0) {
        botsList.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-robot fa-3x text-muted mb-3"></i>
                <h6 class="text-muted">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –±–æ—Ç–æ–≤</h6>
                <p class="text-muted">–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–µ–≥–æ –ø–µ—Ä–≤–æ–≥–æ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –±–æ—Ç–∞!</p>
                <a href="/bots" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –±–æ—Ç–∞</a>
            </div>
        `;
        return;
    }
    
    let botsHTML = '';
    bots.forEach(bot => {
        const statusClass = bot.status === 'running' ? 'success' : 'secondary';
        const statusIcon = bot.status === 'running' ? 'play-circle' : 'pause-circle';
        const uptimeText = bot.uptime ? `<small class="text-muted">–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: ${bot.uptime}</small>` : '';
        
        botsHTML += `
            <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
                <div>
                    <h6 class="mb-1">
                        <i class="fas fa-${bot.bot_type === 'grid' ? 'th' : 'bolt'}"></i>
                        ${bot.bot_type === 'grid' ? 'Grid Bot' : 'Scalp Bot'}
                        <span class="badge bg-${statusClass} ms-2">
                            <i class="fas fa-${statusIcon}"></i>
                            ${bot.status === 'running' ? '–ó–∞–ø—É—â–µ–Ω' : '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}
                        </span>
                    </h6>
                    <small class="text-muted">ID: ${bot.bot_id}</small><br>
                    ${uptimeText}
                </div>
                <div>
                    <a href="/bots" class="btn btn-sm btn-outline-primary">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</a>
                </div>
            </div>
        `;
    });
    
    botsList.innerHTML = botsHTML;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –±–∞–ª–∞–Ω—Å–æ–≤
function updateBalancesList(balances) {
    const balancesList = document.getElementById('balances-list');
    
    if (balances.length === 0) {
        balancesList.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-wallet fa-3x text-muted mb-3"></i>
                <h6 class="text-muted">–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –±–∏—Ä–∂</h6>
                <p class="text-muted">–î–æ–±–∞–≤—å—Ç–µ API –∫–ª—é—á–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –±–∞–ª–∞–Ω—Å–æ–≤</p>
                <a href="/api-keys" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å API –∫–ª—é—á–∏</a>
            </div>
        `;
        return;
    }
    
    let balancesHTML = '';
    balances.forEach(exchange => {
        const modeClass = exchange.mode === 'live' ? 'danger' : 'warning';
        const modeText = exchange.mode === 'live' ? '–†–µ–∞–ª—å–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è' : '–î–µ–º–æ —Ä–µ–∂–∏–º';
        
        balancesHTML += `
            <div class="mb-3 p-3 border rounded">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">
                        <i class="fas fa-exchange-alt"></i>
                        ${exchange.exchange}
                        <span class="badge bg-${modeClass} ms-2">${modeText}</span>
                    </h6>
                    <span class="badge bg-info">${exchange.total_currencies} –≤–∞–ª—é—Ç</span>
                </div>
        `;
        
        if (exchange.error) {
            balancesHTML += `
                <div class="alert alert-warning mb-0">
                    <i class="fas fa-exclamation-triangle"></i>
                    –û—à–∏–±–∫–∞: ${exchange.error}
                </div>
            `;
        } else if (exchange.balances.length === 0) {
            balancesHTML += `
                <div class="text-muted">
                    <i class="fas fa-info-circle"></i>
                    –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–∞–ª–∞–Ω—Å–æ–≤
                </div>
            `;
        } else {
            exchange.balances.slice(0, 3).forEach(balance => {
                balancesHTML += `
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-bold">${balance.currency}</span>
                        <span>${parseFloat(balance.total).toFixed(6)}</span>
                    </div>
                `;
            });
            
            if (exchange.balances.length > 3) {
                balancesHTML += `
                    <div class="text-center mt-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="showAllBalances('${exchange.exchange}', ${JSON.stringify(exchange.balances).replace(/"/g, '&quot;')})">
                            <i class="fas fa-eye"></i> –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ ${exchange.balances.length} –≤–∞–ª—é—Ç
                        </button>
                    </div>
                `;
            }
        }
        
        balancesHTML += `</div>`;
    });
    
    balancesList.innerHTML = balancesHTML;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞—à–±–æ—Ä–¥–∞
function refreshDashboard() {
    const refreshBtn = event.target;
    const originalText = refreshBtn.innerHTML;
    
    refreshBtn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
    refreshBtn.disabled = true;
    
    loadDashboardData().finally(() => {
        refreshBtn.innerHTML = originalText;
        refreshBtn.disabled = false;
        showAlert('success', '–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
setInterval(loadDashboardData, 30000);

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤—Å–µ—Ö –±–∞–ª–∞–Ω—Å–æ–≤
function showAllBalances(exchangeName, balances) {
    const modal = new bootstrap.Modal(document.getElementById('balancesModal'));
    const title = document.getElementById('balancesModalTitle');
    const content = document.getElementById('balancesModalContent');
    
    title.textContent = `–í—Å–µ –±–∞–ª–∞–Ω—Å—ã ${exchangeName}`;
    
    let contentHTML = `
        <div class="row">
            <div class="col-12">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>–í–∞–ª—é—Ç–∞</th>
                                <th>–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</th>
                                <th>–°–≤–æ–±–æ–¥–Ω–æ</th>
                                <th>–í –æ—Ä–¥–µ—Ä–∞—Ö</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
    `;
    
    balances.forEach(balance => {
        const currency = balance.currency;
        const total = parseFloat(balance.total).toFixed(6);
        const free = parseFloat(balance.free).toFixed(6);
        const used = parseFloat(balance.used).toFixed(6);
        
        contentHTML += `
            <tr>
                <td><strong>${currency}</strong></td>
                <td>${total}</td>
                <td>${free}</td>
                <td>${used}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="analyzePair('${currency}')">
                        <i class="fas fa-chart-line"></i> –ê–Ω–∞–ª–∏–∑
                    </button>
                </td>
            </tr>
        `;
    });
    
    contentHTML += `
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>–°–æ–≤–µ—Ç:</strong> –î–ª—è —Ç–æ—Ä–≥–æ–≤–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä—ã —Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º –±–∞–ª–∞–Ω—Å–æ–º –∏ –≤—ã—Å–æ–∫–æ–π –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å—é.
                </div>
            </div>
        </div>
    `;
    
    content.innerHTML = contentHTML;
    modal.show();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–æ—Ä–≥–æ–≤–æ–π –ø–∞—Ä—ã (–∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è –±—É–¥—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)
function analyzePair(currency) {
    showAlert('info', `–ê–Ω–∞–ª–∏–∑ –ø–∞—Ä—ã ${currency}/USDT –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö`);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
});
</script>
{% endblock %}